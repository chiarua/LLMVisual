!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).cql={})}(this,function(e){"use strict";function t(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&(n[r[i]]=e[r[i]])}return n}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function n(e,t){return e(t={exports:{}},t.exports),t.exports}n(function(e){var t=function(){function e(e,t){return null!=t&&e instanceof t}var t,n,r;try{t=Map}catch(e){t=function(){}}try{n=Set}catch(e){n=function(){}}try{r=Promise}catch(e){r=function(){}}function i(o,s,c,u,l){"object"==typeof s&&(c=s.depth,u=s.prototype,l=s.includeNonEnumerable,s=s.circular);var d=[],f=[],p="undefined"!=typeof Buffer;return void 0===s&&(s=!0),void 0===c&&(c=1/0),function o(c,h){if(null===c)return null;if(0===h)return c;var g,m;if("object"!=typeof c)return c;if(e(c,t))g=new t;else if(e(c,n))g=new n;else if(e(c,r))g=new r(function(e,t){c.then(function(t){e(o(t,h-1))},function(e){t(o(e,h-1))})});else if(i.__isArray(c))g=[];else if(i.__isRegExp(c))g=new RegExp(c.source,a(c)),c.lastIndex&&(g.lastIndex=c.lastIndex);else if(i.__isDate(c))g=new Date(c.getTime());else{if(p&&Buffer.isBuffer(c))return g=Buffer.allocUnsafe?Buffer.allocUnsafe(c.length):new Buffer(c.length),c.copy(g),g;e(c,Error)?g=Object.create(c):void 0===u?(m=Object.getPrototypeOf(c),g=Object.create(m)):(g=Object.create(u),m=u)}if(s){var y=d.indexOf(c);if(-1!=y)return f[y];d.push(c),f.push(g)}for(var v in e(c,t)&&c.forEach(function(e,t){var n=o(t,h-1),r=o(e,h-1);g.set(n,r)}),e(c,n)&&c.forEach(function(e){var t=o(e,h-1);g.add(t)}),c){var E;m&&(E=Object.getOwnPropertyDescriptor(m,v)),E&&null==E.set||(g[v]=o(c[v],h-1))}if(Object.getOwnPropertySymbols){var b=Object.getOwnPropertySymbols(c);for(v=0;v<b.length;v++){var T=b[v];(!(C=Object.getOwnPropertyDescriptor(c,T))||C.enumerable||l)&&(g[T]=o(c[T],h-1),C.enumerable||Object.defineProperty(g,T,{enumerable:!1}))}}if(l){var S=Object.getOwnPropertyNames(c);for(v=0;v<S.length;v++){var C,A=S[v];(C=Object.getOwnPropertyDescriptor(c,A))&&C.enumerable||(g[A]=o(c[A],h-1),Object.defineProperty(g,A,{enumerable:!1}))}}return g}(o,c)}function o(e){return Object.prototype.toString.call(e)}function a(e){var t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),t}return i.clonePrototype=function(e){if(null===e)return null;var t=function(){};return t.prototype=e,new t},i.__objToStr=o,i.__isDate=function(e){return"object"==typeof e&&"[object Date]"===o(e)},i.__isArray=function(e){return"object"==typeof e&&"[object Array]"===o(e)},i.__isRegExp=function(e){return"object"==typeof e&&"[object RegExp]"===o(e)},i.__getRegExpFlags=a,i}();e.exports&&(e.exports=t)});var r=function(e,t){t||(t={}),"function"==typeof t&&(t={cmp:t});var n,r="boolean"==typeof t.cycles&&t.cycles,i=t.cmp&&(n=t.cmp,function(e){return function(t,r){var i={key:t,value:e[t]},o={key:r,value:e[r]};return n(i,o)}}),o=[];return function e(t){if(t&&t.toJSON&&"function"==typeof t.toJSON&&(t=t.toJSON()),void 0!==t){if("number"==typeof t)return isFinite(t)?""+t:"null";if("object"!=typeof t)return JSON.stringify(t);var n,a;if(Array.isArray(t)){for(a="[",n=0;n<t.length;n++)n&&(a+=","),a+=e(t[n])||"null";return a+"]"}if(null===t)return"null";if(-1!==o.indexOf(t)){if(r)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}var s=o.push(t)-1,c=Object.keys(t).sort(i&&i(t));for(a="",n=0;n<c.length;n++){var u=c[n],l=e(t[u]);l&&(a&&(a+=","),a+=JSON.stringify(u)+":"+l)}return o.splice(s,1),"{"+a+"}"}}(e)};function i(e,t,n){return e.fields=t||[],e.fname=n,e}function o(e){throw Error(e)}function a(e){var t,n,r,i=[],a=null,s=0,c=e.length,u="";function l(){i.push(u+e.substring(t,n)),u="",t=n+1}for(e+="",t=n=0;n<c;++n)if("\\"===(r=e[n]))u+=e.substring(t,n),t=++n;else if(r===a)l(),a=null,s=-1;else{if(a)continue;t===s&&'"'===r?(t=n+1,a=r):t===s&&"'"===r?(t=n+1,a=r):"."!==r||s?"["===r?(n>t&&l(),s=t=n+1):"]"===r&&(s||o("Access path missing open bracket: "+e),s>0&&l(),s=0,t=n+1):n>t?l():t=n+1}return s&&o("Access path missing closing bracket: "+e),a&&o("Access path missing closing quote: "+e),n>t&&(n++,l()),i}var s=Array.isArray;function c(e){return e===Object(e)}function u(e){return"string"==typeof e}function l(e){return s(e)?"["+e.map(l)+"]":c(e)||u(e)?JSON.stringify(e).replace("\u2028","\\u2028").replace("\u2029","\\u2029"):e}var d=[];(function(e,t){var n=a(e),r="return _["+n.map(l).join("][")+"];";i(Function("_",r),[e=1===n.length?n[0]:e],t||e)})("id"),i(function(e){return e},d,"identity"),i(function(){return 0},d,"zero"),i(function(){return 1},d,"one"),i(function(){return!0},d,"true"),i(function(){return!1},d,"false");function f(e,t,n){var r=[t].concat([].slice.call(n));console[e](...r)}var p=0,h=1,g=2,m=3,y=4;function v(e){return"boolean"==typeof e}function E(e){for(var t={},n=0,r=e.length;n<r;++n)t[e[n]]=!0;return t}Set.prototype.toJSON=function(){return`Set(${[...this].map(e=>r(e)).join(",")})`};const b=r;function T(e,t){return e.indexOf(t)>-1}const S=Object.keys;function C(e){return S(e)}function A(...e){for(const t of e)if(void 0!==t)return t}const N="row",w="column",O="facet",x="x",I="y",M="x2",k="y2",U="latitude",F="longitude",D="latitude2",_="longitude2",P="color",R="fill",L="stroke",$="shape",B="size",W="opacity",H="fillOpacity",G="strokeOpacity",j="strokeWidth",z="text",q="order",Y="detail",Q="key",V="tooltip",K="href",J=Object.assign({x:1,y:1,x2:1,y2:1},{longitude:1,longitude2:1,latitude:1,latitude2:1},{color:1,fill:1,stroke:1,opacity:1,fillOpacity:1,strokeOpacity:1,strokeWidth:1,size:1,shape:1,order:1,text:1,detail:1,key:1,tooltip:1,href:1});function X(e){return"color"===e||"fill"===e||"stroke"===e}const Z=Object.assign({},J,{row:1,column:1,facet:1}),ee=C(Z);t(Z,["order","detail"]),t(Z,["order","detail","row","column","facet"]);const te=t(J,["x","y","x2","y2","latitude","longitude","latitude2","longitude2"]),ne=C(te),re={x:1,y:1},ie=(C(re),t(te,["text","tooltip","href","detail","key","order"])),oe=Object.assign({},re,ie);function ae(e){return!!oe[e]}function se(e,t){return function(e){switch(e){case P:case R:case L:case Y:case Q:case V:case K:case q:case W:case H:case G:case j:case O:case N:case w:return{point:"always",tick:"always",rule:"always",circle:"always",square:"always",bar:"always",rect:"always",line:"always",trail:"always",area:"always",text:"always",geoshape:"always"};case x:case I:case U:case F:return{point:"always",tick:"always",rule:"always",circle:"always",square:"always",bar:"always",rect:"always",line:"always",trail:"always",area:"always",text:"always"};case M:case k:case D:case _:return{rule:"always",bar:"always",rect:"always",area:"always",circle:"binned",point:"binned",square:"binned",tick:"binned"};case B:return{point:"always",tick:"always",rule:"always",circle:"always",square:"always",bar:"always",text:"always",line:"always",trail:"always"};case $:return{point:"always",geoshape:"always"};case z:return{text:"always"}}}(e)[t]}function ce(e){switch(e){case x:case I:case B:case j:case W:case H:case G:case M:case k:return;case O:case N:case w:case $:case z:case V:case K:return"discrete";case P:case R:case L:return"flexible";case U:case F:case D:case _:case Y:case Q:case q:return}throw new Error("rangeType not implemented for "+e)}const ue={orient:1,bandPosition:1,domain:1,domainColor:1,domainDash:1,domainDashOffset:1,domainOpacity:1,domainWidth:1,format:1,formatType:1,grid:1,gridColor:1,gridDash:1,gridDashOffset:1,gridOpacity:1,gridWidth:1,labelAlign:1,labelAngle:1,labelBaseline:1,labelBound:1,labelColor:1,labelFlush:1,labelFlushOffset:1,labelFont:1,labelFontSize:1,labelFontStyle:1,labelFontWeight:1,labelLimit:1,labelOpacity:1,labelOverlap:1,labelPadding:1,labels:1,labelSeparation:1,maxExtent:1,minExtent:1,offset:1,position:1,tickColor:1,tickCount:1,tickDash:1,tickDashOffset:1,tickExtra:1,tickMinStep:1,tickOffset:1,tickOpacity:1,tickRound:1,ticks:1,tickSize:1,tickWidth:1,title:1,titleAlign:1,titleAnchor:1,titleAngle:1,titleBaseline:1,titleColor:1,titleFont:1,titleFontSize:1,titleFontStyle:1,titleFontWeight:1,titleLimit:1,titleOpacity:1,titlePadding:1,titleX:1,titleY:1,values:1,zindex:1},le=Object.assign({},ue,{encoding:1}),de=(Object.assign({gridScale:1,scale:1},ue,{encode:1}),C(le)),fe={clipHeight:1,columnPadding:1,columns:1,cornerRadius:1,direction:1,fillColor:1,format:1,formatType:1,gradientLength:1,gradientOpacity:1,gradientStrokeColor:1,gradientStrokeWidth:1,gradientThickness:1,gridAlign:1,labelAlign:1,labelBaseline:1,labelColor:1,labelFont:1,labelFontSize:1,labelFontStyle:1,labelFontWeight:1,labelLimit:1,labelOffset:1,labelOpacity:1,labelOverlap:1,labelPadding:1,labelSeparation:1,legendX:1,legendY:1,offset:1,orient:1,padding:1,rowPadding:1,strokeColor:1,symbolDash:1,symbolDashOffset:1,symbolFillColor:1,symbolOffset:1,symbolOpacity:1,symbolSize:1,symbolStrokeColor:1,symbolStrokeWidth:1,symbolType:1,tickCount:1,tickMinStep:1,title:1,titleAlign:1,titleAnchor:1,titleBaseline:1,titleColor:1,titleFont:1,titleFontSize:1,titleFontStyle:1,titleFontWeight:1,titleLimit:1,titleOpacity:1,titleOrient:1,titlePadding:1,type:1,values:1,zindex:1},pe=(Object.assign({},fe,{opacity:1,shape:1,stroke:1,fill:1,size:1,strokeWidth:1,encode:1}),C(fe));const he=Object.freeze({INVALID_SPEC:"Invalid spec",FIT_NON_SINGLE:'Autosize "fit" only works for single views and layered views.',CANNOT_FIX_RANGE_STEP_WITH_FIT:'Cannot use a fixed value of "rangeStep" when "autosize" is "fit".',cannotProjectOnChannelWithoutField:function(e){return`Cannot project a selection on encoding channel "${e}", which has no field.`},nearestNotSupportForContinuous:function(e){return`The "nearest" transform is not supported for ${e} marks.`},selectionNotSupported:function(e){return`Selection not supported for ${e} yet`},selectionNotFound:function(e){return`Cannot find a selection named "${e}"`},SCALE_BINDINGS_CONTINUOUS:"Scale bindings are currently only supported for scales with unbinned, continuous domains.",NO_INIT_SCALE_BINDINGS:"Selections bound to scales cannot be separately initialized.",noSuchRepeatedValue:function(e){return`Unknown repeated value "${e}".`},columnsNotSupportByRowCol:function(e){return`The "columns" property cannot be used when "${e}" has nested row/column.`},CONCAT_CANNOT_SHARE_AXIS:"Axes cannot be shared in concatenated views yet (https://github.com/vega/vega-lite/issues/2415).",REPEAT_CANNOT_SHARE_AXIS:"Axes cannot be shared in repeated views yet (https://github.com/vega/vega-lite/issues/2415).",unrecognizedParse:function(e){return`Unrecognized parse "${e}".`},differentParse:function(e,t,n){return`An ancestor parsed field "${e}" as ${n} but a child wants to parse the field as ${t}.`},invalidTransformIgnored:function(e){return`Ignoring an invalid transform: ${b(e)}.`},NO_FIELDS_NEEDS_AS:'If "from.fields" is not specified, "as" has to be a string that specifies the key to be used for the data from the secondary source.',encodingOverridden:function(e){return`Layer's shared ${e.join(",")} channel ${1===e.length?"is":"are"} overriden`},projectionOverridden:function(e){const{parentProjection:t,projection:n}=e;return`Layer's shared projection ${b(t)} is overridden by a child projection ${b(n)}.`},primitiveChannelDef:function(e,t,n){return`Channel ${e} is a ${t}. Converted to {value: ${b(n)}}.`},invalidFieldType:function(e){return`Invalid field type "${e}"`},nonZeroScaleUsedWithLengthMark:function(e,t,n){return`A ${n.scaleType?`${n.scaleType} scale`:n.zeroFalse?"scale with zero=false":"scale with custom domain that excludes zero"} is used to encode ${e}'s ${t}. This can be misleading as the ${"x"===t?"width":"height"} of the ${e} can be arbitrary based on the scale domain. You may want to use point mark instead.`},invalidFieldTypeForCountAggregate:function(e,t){return`Invalid field type "${e}" for aggregate: "${t}", using "quantitative" instead.`},invalidAggregate:function(e){return`Invalid aggregation operator "${e}"`},missingFieldType:function(e,t){return`Missing type for channel "${e}", using "${t}" instead.`},droppingColor:function(e,t){const{fill:n,stroke:r}=t;return`Dropping color ${e} as the plot also has `+(n&&r?"fill and stroke":n?"fill":"stroke")},emptyFieldDef:function(e,t){return`Dropping ${b(e)} from channel "${t}" since it does not contain data field or value.`},latLongDeprecated:function(e,t,n){return`${e}-encoding with type ${t} is deprecated. Replacing with ${n}-encoding.`},LINE_WITH_VARYING_SIZE:"Line marks cannot encode size with a non-groupby field. You may want to use trail marks instead.",incompatibleChannel:function(e,t,n){return`${e} dropped as it is incompatible with "${t}"${n?` when ${n}`:""}.`},invalidEncodingChannel:function(e){return`${e}-encoding is dropped as ${e} is not a valid encoding channel.`},facetChannelShouldBeDiscrete:function(e){return`${e} encoding should be discrete (ordinal / nominal / binned).`},facetChannelDropped:function(e){return`Facet encoding dropped as ${e.join(" and ")} ${e.length>1?"are":"is"} also specified.`},discreteChannelCannotEncode:function(e,t){return`Using discrete channel "${e}" to encode "${t}" field can be misleading as it does not encode ${"ordinal"===t?"order":"magnitude"}.`},BAR_WITH_POINT_SCALE_AND_RANGESTEP_NULL:"Bar mark should not be used with point scale when rangeStep is null. Please use band scale instead.",lineWithRange:function(e,t){return`Line mark is for continuous lines and thus cannot be used with ${e&&t?"x2 and y2":e?"x2":"y2"}. We will use the rule mark (line segments) instead.`},orientOverridden:function(e,t){return`Specified orient "${e}" overridden with "${t}"`},CANNOT_UNION_CUSTOM_DOMAIN_WITH_FIELD_DOMAIN:"custom domain scale cannot be unioned with default field-based domain",cannotUseScalePropertyWithNonColor:function(e){return`Cannot use the scale property "${e}" with non-color channel.`},unaggregateDomainHasNoEffectForRawField:function(e){return`Using unaggregated domain with raw field has no effect (${b(e)}).`},unaggregateDomainWithNonSharedDomainOp:function(e){return`Unaggregated domain not applicable for "${e}" since it produces values outside the origin domain of the source data.`},unaggregatedDomainWithLogScale:function(e){return`Unaggregated domain is currently unsupported for log scale (${b(e)}).`},cannotApplySizeToNonOrientedMark:function(e){return`Cannot apply size to non-oriented mark "${e}".`},rangeStepDropped:function(e){return`rangeStep for "${e}" is dropped as top-level ${"x"===e?"width":"height"} is provided.`},scaleTypeNotWorkWithChannel:function(e,t,n){return`Channel "${e}" does not work with "${t}" scale. We are using "${n}" scale instead.`},scaleTypeNotWorkWithFieldDef:function(e,t){return`FieldDef does not work with "${e}" scale. We are using "${t}" scale instead.`},scalePropertyNotWorkWithScaleType:function(e,t,n){return`${n}-scale's "${t}" is dropped as it does not work with ${e} scale.`},scaleTypeNotWorkWithMark:function(e,t){return`Scale type "${t}" does not work with mark "${e}".`},mergeConflictingProperty:function(e,t,n,r){return`Conflicting ${t.toString()} property "${e.toString()}" (${b(n)} and ${b(r)}).  Using ${b(n)}.`},independentScaleMeansIndependentGuide:function(e){return`Setting the scale to be independent for "${e}" means we also have to set the guide (axis or legend) to be independent.`},domainSortDropped:function(e){return`Dropping sort property ${b(e)} as unioned domains only support boolean or op 'count'.`},UNABLE_TO_MERGE_DOMAINS:"Unable to merge domains",MORE_THAN_ONE_SORT:"Domains that should be unioned has conflicting sort properties. Sort will be set to true.",INVALID_CHANNEL_FOR_AXIS:"Invalid channel for axis.",cannotStackRangedMark:function(e){return`Cannot stack "${e}" if there is already "${e}2"`},cannotStackNonLinearScale:function(e){return`Cannot stack non-linear scale (${e})`},stackNonSummativeAggregate:function(e){return`Stacking is applied even though the aggregate function is non-summative ("${e}")`},invalidTimeUnit:function(e,t){return`Invalid ${e}: ${b(t)}`},dayReplacedWithDate:function(e){return`Time unit "${e}" is not supported. We are replacing it with ${e.replace("day","date")}.`},droppedDay:function(e){return`Dropping day from datetime ${b(e)} as day cannot be combined with other units.`},errorBarCenterAndExtentAreNotNeeded:function(e,t){return`${t?"extent ":""}${t&&e?"and ":""}${e?"center ":""}${t&&e?"are ":"is "}not needed when data are aggregated.`},errorBarCenterIsUsedWithWrongExtent:function(e,t,n){return`${e} is not usually used with ${t} for ${n}.`},errorBarContinuousAxisHasCustomizedAggregate:function(e,t){return`Continuous axis should not have customized aggregation function ${e}; ${t} already agregates the axis.`},errorBarCenterIsNotNeeded:function(e,t){return`Center is not needed to be specified in ${t} when extent is ${e}.`},errorBand1DNotSupport:function(e){return`1D error band does not support ${e}`},channelRequiredForBinned:function(e){return`Channel ${e} is required for "binned" bin`},domainRequiredForThresholdScale:function(e){return`Domain for ${e} is required for threshold scale`}}),ge=(ye=g||p,{level:function(e){return arguments.length?(ye=+e,this):ye},error:function(){return ye>=h&&f(me||"error","ERROR",arguments),this},warn:function(){return ye>=g&&f(me||"warn","WARN",arguments),this},info:function(){return ye>=m&&f(me||"log","INFO",arguments),this},debug:function(){return ye>=y&&f(me||"log","DEBUG",arguments),this}});var me,ye;let ve=ge;function Ee(...e){ve.warn.apply(ve,arguments)}const be={quantitative:1,ordinal:1,temporal:1,nominal:1,geojson:1},Te="quantitative",Se="ordinal",Ce="temporal",Ae="nominal",Ne="geojson";function we(e){if(e)switch(e=e.toLowerCase()){case"q":case Te:return"quantitative";case"t":case Ce:return"temporal";case"o":case Se:return"ordinal";case"n":case Ae:return"nominal";case Ne:return"geojson"}}var Oe;!function(e){e.LINEAR="linear",e.LOG="log",e.POW="pow",e.SQRT="sqrt",e.SYMLOG="symlog",e.TIME="time",e.UTC="utc",e.QUANTILE="quantile",e.QUANTIZE="quantize",e.THRESHOLD="threshold",e.BIN_ORDINAL="bin-ordinal",e.ORDINAL="ordinal",e.POINT="point",e.BAND="band"}(Oe||(Oe={}));const xe=S({linear:"numeric",log:"numeric",pow:"numeric",sqrt:"numeric",symlog:"numeric",time:"time",utc:"time",ordinal:"ordinal","bin-ordinal":"bin-ordinal",point:"ordinal-position",band:"ordinal-position",quantile:"discretizing",quantize:"discretizing",threshold:"discretizing"}),Ie=["linear","log","pow","sqrt","symlog","time","utc"],Me=E(Ie),ke=E(["quantile","quantize","threshold"]),Ue=E(Ie.concat(["quantile","quantize","threshold"])),Fe=E(["ordinal","bin-ordinal","point","band"]);function De(e){return e in Fe}function _e(e){return e in Me}const Pe={type:1,domain:1,range:1,rangeStep:1,scheme:1,bins:1,reverse:1,round:1,clamp:1,nice:1,base:1,exponent:1,constant:1,interpolate:1,zero:1,padding:1,paddingInner:1,paddingOuter:1},Re=C(Pe);t(Pe,["type","domain","range","rangeStep","scheme"]),function(){const e={};for(const t of ee)for(const n of S(be))for(const r of xe){const i=He(t,n);We(t,r)&&Be(r,n)&&(e[i]=e[i]||[],e[i].push(r))}}();function Le(e,t){switch(t){case"type":case"domain":case"reverse":case"range":return!0;case"scheme":case"interpolate":return!T(["point","band","identity"],e);case"bins":return!T(["point","band","identity","ordinal"],e);case"round":return _e(e)||"band"===e||"point"===e;case"padding":return _e(e)||T(["point","band"],e);case"paddingOuter":case"rangeStep":return T(["point","band"],e);case"paddingInner":return"band"===e;case"clamp":return _e(e);case"nice":return _e(e)||"quantize"===e||"threshold"===e;case"exponent":return"pow"===e;case"base":return"log"===e;case"constant":return"symlog"===e;case"zero":return e in Ue&&!T(["log","time","utc","threshold","quantile"],e)}throw new Error(`Invalid scale property ${t}.`)}function $e(e,t){switch(t){case"interpolate":case"scheme":return X(e)?void 0:he.cannotUseScalePropertyWithNonColor(e);case"type":case"bins":case"domain":case"range":case"base":case"exponent":case"constant":case"nice":case"padding":case"paddingInner":case"paddingOuter":case"rangeStep":case"reverse":case"round":case"clamp":case"zero":return}throw new Error(`Invalid scale property "${t}".`)}function Be(e,t){return T([Se,Ae],t)?void 0===e||De(e):t===Ce?T([Oe.TIME,Oe.UTC,void 0],e):t!==Te||T([Oe.LOG,Oe.POW,Oe.SQRT,Oe.SYMLOG,Oe.QUANTILE,Oe.QUANTIZE,Oe.THRESHOLD,Oe.LINEAR,void 0],e)}function We(e,t){switch(e){case x:case I:return _e(t)||T(["band","point"],t);case B:case j:case W:case H:case G:return _e(t)||t in ke||T(["band","point"],t);case P:case R:case L:return"band"!==t;case $:return"ordinal"===t}return!1}function He(e,t){return e+"_"+t}var Ge=n(function(e){var t=e.exports;t.namedfunc=function(e,t){return t.__name__=e,t},t.name=function(e){return null==e?null:e.__name__},t.identity=function(e){return e},t.true=t.namedfunc("true",function(){return!0}),t.false=t.namedfunc("false",function(){return!1}),t.duplicate=function(e){return JSON.parse(JSON.stringify(e))},t.equal=function(e,t){return JSON.stringify(e)===JSON.stringify(t)},t.extend=function(e){for(var t,n,r=1,i=arguments.length;r<i;++r)for(n in t=arguments[r])e[n]=t[n];return e},t.length=function(e){return null!=e&&null!=e.length?e.length:null},t.keys=function(e){var t,n=[];for(t in e)n.push(t);return n},t.vals=function(e){var t,n=[];for(t in e)n.push(e[t]);return n},t.toMap=function(e,n){return(n=t.$(n))?e.reduce(function(e,t){return e[n(t)]=1,e},{}):e.reduce(function(e,t){return e[t]=1,e},{})},t.keystr=function(e){var t=e.length;if(!t)return"";for(var n=String(e[0]),r=1;r<t;++r)n+="|"+String(e[r]);return n};var n=Object.prototype.toString;t.isObject=function(e){return e===Object(e)},t.isFunction=function(e){return"[object Function]"===n.call(e)},t.isString=function(e){return"string"==typeof value||"[object String]"===n.call(e)},t.isArray=Array.isArray||function(e){return"[object Array]"===n.call(e)},t.isNumber=function(e){return"number"==typeof e||"[object Number]"===n.call(e)},t.isBoolean=function(e){return!0===e||!1===e||"[object Boolean]"==n.call(e)},t.isDate=function(e){return"[object Date]"===n.call(e)},t.isValid=function(e){return null!=e&&e==e},t.isBuffer="function"==typeof Buffer&&Buffer.isBuffer||t.false,t.number=function(e){return null==e||""===e?null:+e},t.boolean=function(e){return null==e||""===e?null:"false"!==e&&!!e},t.date=function(e,t){var n=t||Date;return null==e||""===e?null:n.parse(e)},t.array=function(e){return null!=e?t.isArray(e)?e:[e]:[]},t.str=function(e){return t.isArray(e)?"["+e.map(t.str)+"]":t.isObject(e)||t.isString(e)?JSON.stringify(e).replace("\u2028","\\u2028").replace("\u2029","\\u2029"):e};var r=/\[(.*?)\]|[^.\[]+/g;function i(e,t){var n,r="";for(n=0;n<e;++n)r+=t;return r}function o(e,t,n){var r=0,i=e.split(a);return(e=n?(i=i.reverse()).filter(function(e){return(r+=e.length)<=t}).reverse():i.filter(function(e){return(r+=e.length)<=t})).length?e.join("").trim():i[0].slice(0,t)}t.field=function(e){return String(e).match(r).map(function(e){return"["!==e[0]?e:"'"!==e[1]&&'"'!==e[1]?e.slice(1,-1):e.slice(2,-2).replace(/\\(["'])/g,"$1")})},t.accessor=function(e){return null==e||t.isFunction(e)?e:t.namedfunc(e,Function("x","return x["+t.field(e).map(t.str).join("][")+"];"))},t.$=t.accessor,t.mutator=function(e){var n;return t.isString(e)&&(n=t.field(e)).length>1?function(e,t){for(var r=0;r<n.length-1;++r)e=e[n[r]];e[n[r]]=t}:function(t,n){t[e]=n}},t.$func=function(e,n){return function(r){r=t.$(r)||t.identity;var i=e+(t.name(r)?"_"+t.name(r):"");return t.namedfunc(i,function(e){return n(r(e))})}},t.$valid=t.$func("valid",t.isValid),t.$length=t.$func("length",t.length),t.$in=function(e,n){e=t.$(e);var r=t.isArray(n)?t.toMap(n):n;return function(t){return!!r[e(t)]}},t.comparator=function(e){var n=[];return void 0===e&&(e=[]),e=t.array(e).map(function(e){var r=1;return"-"===e[0]?(r=-1,e=e.slice(1)):"+"===e[0]&&(r=1,e=e.slice(1)),n.push(r),t.accessor(e)}),function(r,i){var o,a,s,c;for(o=0,a=e.length;o<a;++o)if(s=e[o],c=t.cmp(s(r),s(i)))return c*n[o];return 0}},t.cmp=function(e,t){return(e<t||null==e)&&null!=t?-1:(e>t||null==t)&&null!=e?1:(t=t instanceof Date?+t:t,(e=e instanceof Date?+e:e)!==e&&t==t?-1:t!=t&&e==e?1:0)},t.numcmp=function(e,t){return e-t},t.stablesort=function(e,t,n){var r=e.reduce(function(e,t,r){return e[n(t)]=r,e},{});return e.sort(function(e,i){var o=t(e),a=t(i);return o<a?-1:o>a?1:r[n(e)]-r[n(i)]}),e},t.permute=function(e){for(var t,n,r=e.length;r;)n=Math.floor(Math.random()*r--),t=e[r],e[r]=e[n],e[n]=t},t.pad=function(e,t,n,r){r=r||" ";var o=t-e.length;if(o<=0)return e;switch(n){case"left":return i(o,r)+e;case"middle":case"center":return i(Math.floor(o/2),r)+e+i(Math.ceil(o/2),r);default:return e+i(o,r)}},t.truncate=function(e,t,n,r,i){var a=e.length;if(a<=t)return e;i=void 0!==i?String(i):"…";var s=Math.max(0,t-i.length);switch(n){case"left":return i+(r?o(e,s,1):e.slice(a-s));case"middle":case"center":var c=Math.ceil(s/2),u=Math.floor(s/2);return(r?o(e,c):e.slice(0,c))+i+(r?o(e,u,1):e.slice(a-u));default:return(r?o(e,s):e.slice(0,s))+i}};var a=/([\u0009\u000A\u000B\u000C\u000D\u0020\u00A0\u1680\u180E\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200A\u202F\u205F\u2028\u2029\u3000\uFEFF])/}),je=Ge.isArray,ze=Ge.cmp,qe=Ge.keys,Ye=Ge.duplicate,Qe=Ge.extend,Ve=Ge.isObject,Ke=Ge.isBoolean,Je=Ge.toMap,Xe=Ge.isString;function Ze(e,t){return-1!==e.indexOf(t)}function et(e,t){for(let n=0;n<e.length;n++)if(!t(e[n],n))return!1;return!0}function tt(e,t,n){if(e.forEach)e.forEach.call(n,t);else for(let r in e)t.call(n,e[r],r,e)}function nt(e,t){let n,r=0;for(n in e)if(t(e[n],n,r++))return!0;return!1}function rt(e,t){return e.filter(function(e){return!Ze(t,e)})}function it(e){return Object.keys(e)}var ot=Object.freeze({isArray:je,contains:Ze,every:et,forEach:tt,some:nt,nestedMap:function e(t,n){return t.map(t=>je(t)?e(t,n):n(t))},without:rt,flagKeys:it,cmp:ze,keys:qe,duplicate:Ye,extend:Qe,isObject:Ve,isBoolean:Ke,toMap:Je});function at(e){return!!e.parent}const st={channel:1,aggregate:1,autoCount:1,bin:1,timeUnit:1,hasFn:1,sort:1,stack:1,field:1,type:1,format:1,scale:1,axis:1,legend:1,value:1},ct=it(st);function ut(e){return e in st}const lt={bin:1,scale:1,sort:1,axis:1,legend:1};function dt(e){return lt[e]}const ft=["maxbins","divide","extent","base","step","steps","minstep"],pt=["field","op","order"],ht=ft.map(e=>({parent:"bin",child:e})),gt=pt.map(e=>({parent:"sort",child:e})),mt=Re.map(e=>({parent:"scale",child:e})),yt=de.map(e=>({parent:"axis",child:e})),vt=pe.map(e=>({parent:"legend",child:e})),Et=[].concat(ht,gt,mt,yt,vt),bt=["width","height","background","padding","title"],Tt=".";function St(e){return at(e)?e.parent+Tt+e.child:e}function Ct(e){const t=e.split(Tt);if(1===t.length)return e;if(2===t.length)return{parent:t[0],child:t[1]};throw"Invalid property key with "+t.length+" dots: "+e}const At=Et.reduce((e,t)=>(e[t.parent]=e[t.parent]||[],e[t.parent][t.child]=t,e),{});function Nt(e,t){return(At[e]||{})[t]}function wt(e){return ut(e)||at(e)}const Ot=[].concat(ct,Et),xt=["type","field","bin","timeUnit","aggregate","autoCount","channel","mark","stack","scale","sort","axis","legend"].concat(ht,mt,yt,vt,gt);var It;!function(e){e.MARK="mark",e.TRANSFORM="transform",e.STACK="stack",e.FORMAT="format",e.CHANNEL="channel",e.AGGREGATE="aggregate",e.AUTOCOUNT="autoCount",e.BIN="bin",e.HAS_FN="hasFn",e.TIMEUNIT="timeUnit",e.FIELD="field",e.TYPE="type",e.SORT="sort",e.SCALE="scale",e.AXIS="axis",e.LEGEND="legend",e.WIDTH="width",e.HEIGHT="height",e.BACKGROUND="background",e.PADDING="padding",e.TITLE="title"}(It||(It={}));var Mt=Object.freeze({isEncodingNestedProp:at,ENCODING_TOPLEVEL_PROPS:ct,isEncodingTopLevelProperty:ut,isEncodingNestedParent:dt,BIN_CHILD_PROPS:ft,SORT_CHILD_PROPS:pt,SORT_PROPS:gt,SCALE_PROPS:mt,ENCODING_NESTED_PROPS:Et,VIEW_PROPS:bt,toKey:St,fromKey:Ct,getEncodingNestedProp:Nt,isEncodingProperty:wt,ALL_ENCODING_PROPS:Ot,DEFAULT_PROP_PRECEDENCE:xt,get Property(){return It}});const kt="area",Ut="bar",Ft="point",Dt="circle",_t="square";function Pt(e){return T(["line","area","trail"],e)}E(C({area:1,bar:1,line:1,point:1,text:1,tick:1,trail:1,rect:1,geoshape:1,rule:1,circle:1,square:1}));const Rt=["january","february","march","april","may","june","july","august","september","october","november","december"],Lt=(Rt.map(e=>e.substr(0,3)),["sunday","monday","tuesday","wednesday","thursday","friday","saturday"]);Lt.map(e=>e.substr(0,3));var $t;!function(e){e.YEAR="year",e.MONTH="month",e.DAY="day",e.DATE="date",e.HOURS="hours",e.MINUTES="minutes",e.SECONDS="seconds",e.MILLISECONDS="milliseconds",e.YEARMONTH="yearmonth",e.YEARMONTHDATE="yearmonthdate",e.YEARMONTHDATEHOURS="yearmonthdatehours",e.YEARMONTHDATEHOURSMINUTES="yearmonthdatehoursminutes",e.YEARMONTHDATEHOURSMINUTESSECONDS="yearmonthdatehoursminutesseconds",e.MONTHDATE="monthdate",e.MONTHDATEHOURS="monthdatehours",e.HOURSMINUTES="hoursminutes",e.HOURSMINUTESSECONDS="hoursminutesseconds",e.MINUTESSECONDS="minutesseconds",e.SECONDSMILLISECONDS="secondsmilliseconds",e.QUARTER="quarter",e.YEARQUARTER="yearquarter",e.QUARTERMONTH="quartermonth",e.YEARQUARTERMONTH="yearquartermonth",e.UTCYEAR="utcyear",e.UTCMONTH="utcmonth",e.UTCDAY="utcday",e.UTCDATE="utcdate",e.UTCHOURS="utchours",e.UTCMINUTES="utcminutes",e.UTCSECONDS="utcseconds",e.UTCMILLISECONDS="utcmilliseconds",e.UTCYEARMONTH="utcyearmonth",e.UTCYEARMONTHDATE="utcyearmonthdate",e.UTCYEARMONTHDATEHOURS="utcyearmonthdatehours",e.UTCYEARMONTHDATEHOURSMINUTES="utcyearmonthdatehoursminutes",e.UTCYEARMONTHDATEHOURSMINUTESSECONDS="utcyearmonthdatehoursminutesseconds",e.UTCMONTHDATE="utcmonthdate",e.UTCMONTHDATEHOURS="utcmonthdatehours",e.UTCHOURSMINUTES="utchoursminutes",e.UTCHOURSMINUTESSECONDS="utchoursminutesseconds",e.UTCMINUTESSECONDS="utcminutesseconds",e.UTCSECONDSMILLISECONDS="utcsecondsmilliseconds",e.UTCQUARTER="utcquarter",e.UTCYEARQUARTER="utcyearquarter",e.UTCQUARTERMONTH="utcquartermonth",e.UTCYEARQUARTERMONTH="utcyearquartermonth"}($t||($t={}));const Bt={year:1,quarter:1,month:1,day:1,date:1,hours:1,minutes:1,seconds:1,milliseconds:1},Wt=C(Bt);function Ht(e){return!!Bt[e]}const Gt={utcyear:1,utcquarter:1,utcmonth:1,utcday:1,utcdate:1,utchours:1,utcminutes:1,utcseconds:1,utcmilliseconds:1};function jt(e){return!!Gt[e]}const zt={utcyearquarter:1,utcyearquartermonth:1,utcyearmonth:1,utcyearmonthdate:1,utcyearmonthdatehours:1,utcyearmonthdatehoursminutes:1,utcyearmonthdatehoursminutesseconds:1,utcquartermonth:1,utcmonthdate:1,utcmonthdatehours:1,utchoursminutes:1,utchoursminutesseconds:1,utcminutesseconds:1,utcsecondsmilliseconds:1},qt=Object.assign({},Gt,zt);const Yt=Object.assign({},Bt,Gt,{yearquarter:1,yearquartermonth:1,yearmonth:1,yearmonthdate:1,yearmonthdatehours:1,yearmonthdatehoursminutes:1,yearmonthdatehoursminutesseconds:1,quartermonth:1,monthdate:1,monthdatehours:1,hoursminutes:1,hoursminutesseconds:1,minutesseconds:1,secondsmilliseconds:1},zt);const Qt={year:"setFullYear",month:"setMonth",date:"setDate",hours:"setHours",minutes:"setMinutes",seconds:"setSeconds",milliseconds:"setMilliseconds",quarter:null,day:null};function Vt(e,t){const n=!!qt[e];const r=n?new Date(Date.UTC(1972,0,1,0,0,0,0)):new Date(1972,0,1,0,0,0,0);for(const i of Wt)if(Jt(e,i))switch(i){case $t.DAY:throw new Error("Cannot convert to TimeUnits containing 'day'");case $t.QUARTER:{const{getDateMethod:e,setDateMethod:i}=Kt("month",n);r[i](3*Math.floor(t[e]()/3));break}default:{const{getDateMethod:e,setDateMethod:o}=Kt(i,n);r[o](t[e]())}}return r}function Kt(e,t){const n=Qt[e];return{setDateMethod:t?"setUTC"+n.substr(3):n,getDateMethod:"get"+(t?"UTC":"")+n.substr(3)}}function Jt(e,t){const n=e.indexOf(t);return n>-1&&(t!==$t.SECONDS||0===n||"i"!==e.charAt(n-1))}const Xt="?";function Zt(e){return en(e)||tn(e)}function en(e){return e===Xt}function tn(e){return!(void 0===e||null==e||!e.enum&&!e.name||je(e))}function nn(e,t,n){return Qe({},{name:t,enum:n},e===Xt?{}:e)}function rn(e){let t={},n={};for(const r of e){const e=[0];for(let t=0;t<r.length;t++)r.charAt(t).toUpperCase()===r.charAt(t)&&e.push(t);let i=e.map(e=>r.charAt(e)).join("").toLowerCase();if(n[i])if(e[e.length-1]===r.length-1||n[i=e.concat([r.length-1]).map(e=>r.charAt(e)).join("").toLowerCase()])for(let e=1;!t[r];e++){let o=i+"_"+e;if(!n[o]){t[r]=o,n[o]=!0;break}}else t[r]=i,n[i]=!0;else t[r]=i,n[i]=!0}return t}const on={mark:"m",channel:"c",aggregate:"a",autoCount:"#",hasFn:"h",bin:"b",sort:"so",stack:"st",scale:"s",format:"f",axis:"ax",legend:"l",value:"v",timeUnit:"tu",field:"f",type:"t",binProps:{maxbins:"mb",min:"mi",max:"ma",base:"b",step:"s",steps:"ss",minstep:"ms",divide:"d"},sortProps:{field:"f",op:"o",order:"or"},scaleProps:rn(Re),axisProps:rn(de),legendProps:rn(pe)};function an(e){if(at(e))return on[e.parent]+"-"+on[e.parent+"Props"][e.child];if(on[e])return on[e];throw new Error("Default name undefined for "+e)}const sn=[!1,!0],cn={maxbins:[5,10,20],extent:[void 0],base:[10],step:[void 0],steps:[void 0],minstep:[void 0],divide:[[5,2]],binned:[!1],anchor:[void 0],nice:[!0]},un={field:[void 0],op:["min","mean"],order:["ascending","descending"]},ln={type:[void 0,Oe.LOG],domain:[void 0],base:[void 0],exponent:[1,2],constant:[void 0],bins:[void 0],clamp:sn,nice:sn,reverse:sn,round:sn,zero:sn,padding:[void 0],paddingInner:[void 0],paddingOuter:[void 0],interpolate:[void 0],range:[void 0],rangeStep:[17,21],scheme:[void 0]},dn={zindex:[1,0],offset:[void 0],orient:[void 0],values:[void 0],bandPosition:[void 0],encoding:[void 0],domain:sn,domainColor:[void 0],domainDash:[void 0],domainDashOffset:[void 0],domainOpacity:[void 0],domainWidth:[void 0],formatType:[void 0],grid:sn,gridColor:[void 0],gridDash:[void 0],gridDashOffset:[void 0],gridOpacity:[void 0],gridWidth:[void 0],format:[void 0],labels:sn,labelAlign:[void 0],labelAngle:[void 0],labelBaseline:[void 0],labelColor:[void 0],labelFlushOffset:[void 0],labelFont:[void 0],labelFontSize:[void 0],labelFontStyle:[void 0],labelFontWeight:[void 0],labelLimit:[void 0],labelOpacity:[void 0],labelSeparation:[void 0],labelOverlap:[void 0],labelPadding:[void 0],labelBound:[void 0],labelFlush:[void 0],maxExtent:[void 0],minExtent:[void 0],position:[void 0],ticks:sn,tickColor:[void 0],tickCount:[void 0],tickDash:[void 0],tickExtra:[void 0],tickDashOffset:[void 0],tickMinStep:[void 0],tickOffset:[void 0],tickOpacity:[void 0],tickRound:[void 0],tickSize:[void 0],tickWidth:[void 0],title:[void 0],titleAlign:[void 0],titleAnchor:[void 0],titleAngle:[void 0],titleBaseline:[void 0],titleColor:[void 0],titleFont:[void 0],titleFontSize:[void 0],titleFontStyle:[void 0],titleFontWeight:[void 0],titleLimit:[void 0],titleOpacity:[void 0],titlePadding:[void 0],titleX:[void 0],titleY:[void 0]},fn={orient:["left","right"],format:[void 0],type:[void 0],values:[void 0],zindex:[void 0],clipHeight:[void 0],columnPadding:[void 0],columns:[void 0],cornerRadius:[void 0],direction:[void 0],encoding:[void 0],fillColor:[void 0],formatType:[void 0],gridAlign:[void 0],offset:[void 0],padding:[void 0],rowPadding:[void 0],strokeColor:[void 0],labelAlign:[void 0],labelBaseline:[void 0],labelColor:[void 0],labelFont:[void 0],labelFontSize:[void 0],labelFontStyle:[void 0],labelFontWeight:[void 0],labelLimit:[void 0],labelOffset:[void 0],labelOpacity:[void 0],labelOverlap:[void 0],labelPadding:[void 0],labelSeparation:[void 0],legendX:[void 0],legendY:[void 0],gradientLength:[void 0],gradientOpacity:[void 0],gradientStrokeColor:[void 0],gradientStrokeWidth:[void 0],gradientThickness:[void 0],symbolDash:[void 0],symbolDashOffset:[void 0],symbolFillColor:[void 0],symbolOffset:[void 0],symbolOpacity:[void 0],symbolSize:[void 0],symbolStrokeColor:[void 0],symbolStrokeWidth:[void 0],symbolType:[void 0],tickCount:[void 0],tickMinStep:[void 0],title:[void 0],titleAnchor:[void 0],titleAlign:[void 0],titleBaseline:[void 0],titleColor:[void 0],titleFont:[void 0],titleFontSize:[void 0],titleFontStyle:[void 0],titleFontWeight:[void 0],titleLimit:[void 0],titleOpacity:[void 0],titleOrient:[void 0],titlePadding:[void 0]},pn={mark:[Ft,Ut,"line",kt,"rect","tick","text"],channel:[x,I,N,w,B,P],aggregate:[void 0,"mean"],autoCount:sn,bin:sn,hasFn:sn,timeUnit:[void 0,$t.YEAR,$t.MONTH,$t.MINUTES,$t.SECONDS],field:[void 0],type:[Ae,Se,Te,Ce],sort:["ascending","descending"],stack:["zero","normalize","center",null],value:[void 0],format:[void 0],title:[void 0],scale:[!0],axis:sn,legend:sn,binProps:cn,sortProps:un,scaleProps:ln,axisProps:dn,legendProps:fn};function hn(e,t,n){if("field"===e||at(e)&&"sort"===e.parent&&"field"===e.child)return t.fieldNames();let r;if(void 0!==(r=at(e)?n.enum[e.parent+"Props"][e.child]:n.enum[e]))return r;throw new Error("No default enumValues for "+JSON.stringify(e))}var gn=Object.freeze({SHORT_WILDCARD:Xt,isWildcard:Zt,isShortWildcard:en,isWildcardDef:tn,initWildcard:nn,DEFAULT_NAME:on,getDefaultName:an,DEFAULT_ENUM_INDEX:pn,getDefaultEnumValues:hn});const mn={verbose:!1,defaultSpecConfig:{line:{point:!0},scale:{useUnaggregatedDomain:!0}},propertyPrecedence:xt.map(St),enum:pn,numberNominalProportion:.05,numberNominalLimit:40,constraintManuallySpecifiedValue:!1,autoAddCount:!1,hasAppropriateGraphicTypeForMark:!0,omitAggregate:!1,omitAggregatePlotWithDimensionOnlyOnFacet:!0,omitAggregatePlotWithoutDimension:!1,omitBarLineAreaWithOcclusion:!0,omitBarTickWithSize:!0,omitMultipleNonPositionalChannels:!0,omitRaw:!1,omitRawContinuousFieldForAggregatePlot:!0,omitRepeatedField:!0,omitNonPositionalOrFacetOverPositionalChannels:!0,omitTableWithOcclusionIfAutoAddCount:!0,omitVerticalDotPlot:!1,omitInvalidStackSpec:!0,omitNonSumStack:!0,preferredBinAxis:x,preferredTemporalAxis:x,preferredOrdinalAxis:I,preferredNominalAxis:I,preferredFacet:N,minCardinalityForBin:15,maxCardinalityForCategoricalColor:20,maxCardinalityForFacet:20,maxCardinalityForShape:6,timeUnitShouldHaveVariation:!0,typeMatchesSchemaType:!0,stylize:!0,smallRangeStepForHighCardinalityOrFacet:{maxCardinality:10,rangeStep:12},nominalColorScaleForHighCardinality:{maxCardinality:10,palette:"category20"},xAxisOnTopForHighYCardinalityWithoutColumn:{maxCardinality:30},maxGoodCardinalityForFacet:5,maxGoodCardinalityForColor:7,minPercentUniqueForKey:.8,minCardinalityForKey:50};function yn(e,t){return Object.assign({},pn[t+"Props"],e[t+"Props"])}var vn=Object.freeze({DEFAULT_QUERY_CONFIG:mn,extendConfig:function(e){return Object.assign({},mn,e,{enum:(t=e.enum,Object.assign({},pn,t,{binProps:yn(t,"bin"),scaleProps:yn(t,"scale"),axisProps:yn(t,"axis"),legendProps:yn(t,"legend")}))});var t}});const En={argmax:1,argmin:1,average:1,count:1,distinct:1,max:1,mean:1,median:1,min:1,missing:1,q1:1,q3:1,ci0:1,ci1:1,stderr:1,stdev:1,stdevp:1,sum:1,valid:1,values:1,variance:1,variancep:1};function bn(e){return!!e&&!!e.argmin}function Tn(e){return!!e&&!!e.argmax}function Sn(e){return u(e)&&!!En[e]}const Cn=["count","sum","distinct","valid","missing"];E(["mean","average","median","q1","q3","min","max"]);function An(e){return!0===e||Nn(e)&&!e.binned}function Nn(e){return c(e)}function wn(e){switch(e){case N:case w:case B:case P:case R:case L:case j:case W:case H:case G:case $:return 6;default:return 10}}function On(e){return!!e&&!!e.condition&&!s(e.condition)&&xn(e.condition)}function xn(e){return!(!e||!e.field&&"count"!==e.aggregate)}function In(e){return xn(e)&&u(e.field)}function Mn(e,t={}){let n=e.field;const r=t.prefix;let i=t.suffix,o="";if(Fn(e))n=function(e){return 0===e.indexOf("__")}(s="count")?s:`__${s}`;else{let r;if(!t.nofn)if(function(e){return!!e.op}(e))r=e.op;else{const{bin:a,aggregate:s,timeUnit:c}=e;An(a)?(r=function(e){return v(e)&&(e=_n(e,void 0)),"bin"+S(e).map(t=>(function(e){const t=e.replace(/\W/g,"_");return(e.match(/^\d+/)?"_":"")+t})(`_${t}_${e[t]}`)).join("")}(a),i=(t.binSuffix||"")+(t.suffix||"")):s?Tn(s)?(o=`.${n}`,n=`argmax_${s.argmax}`):bn(s)?(o=`.${n}`,n=`argmin_${s.argmin}`):r=String(s):c&&(r=String(c))}r&&(n=n?`${r}_${n}`:r)}var s;return i&&(n=`${n}_${i}`),r&&(n=`${r}_${n}`),t.forAs?n:t.expr?function(e,t="datum"){return`${t}[${l(a(e).join("."))}]`}(n,t.expr)+o:`${a(n).map(e=>e.replace(".","\\.")).join("\\.")}`+o}function kn(e){switch(e.type){case"nominal":case"ordinal":case"geojson":return!0;case"quantitative":return!!e.bin;case"temporal":return!1}throw new Error(he.invalidFieldType(e.type))}function Un(e){return!kn(e)}function Fn(e){return"count"===e.aggregate}function Dn(e){return xn(e)?e:On(e)?e.condition:void 0}function _n(e,t){return v(e)?{maxbins:wn(t)}:"binned"===e?{binned:!0}:e.maxbins||e.step?e:Object.assign({},e,{maxbins:wn(t)})}const Pn={compatible:!0};function Rn(e,t){const n=e.type;if("geojson"===n&&"shape"!==t)return{compatible:!1,warning:`Channel ${t} should not be used with a geojson data.`};switch(t){case"row":case"column":case"facet":return Un(e)?{compatible:!1,warning:he.facetChannelShouldBeDiscrete(t)}:Pn;case"x":case"y":case"color":case"fill":case"stroke":case"text":case"detail":case"key":case"tooltip":case"href":return Pn;case"longitude":case"longitude2":case"latitude":case"latitude2":return n!==Te?{compatible:!1,warning:`Channel ${t} should be used with a quantitative field only, not ${e.type} field.`}:Pn;case"opacity":case"fillOpacity":case"strokeOpacity":case"strokeWidth":case"size":case"x2":case"y2":return"nominal"!==n||e.sort?Pn:{compatible:!1,warning:`Channel ${t} should not be used with an unsorted discrete field.`};case"shape":return T(["ordinal","nominal","geojson"],e.type)?Pn:{compatible:!1,warning:"Shape channel should be used with only either discrete or geojson data."};case"order":return"nominal"!==e.type||"sort"in e?Pn:{compatible:!1,warning:"Channel order is inappropriate for nominal field, which has no inherent order."}}throw new Error("channelCompatability not implemented for channel "+t)}var Ln;function $n(e,t,n,r){const i=function(e,t,n){switch(t.type){case"nominal":case"ordinal":if(X(e)||"discrete"===ce(e))return"shape"===e&&"ordinal"===t.type&&Ee(he.discreteChannelCannotEncode(e,"ordinal")),"ordinal";if(T(["x","y"],e)){if(T(["rect","bar","rule"],n))return"band";if("bar"===n)return"band"}return"point";case"temporal":return X(e)?"time":"discrete"===ce(e)?(Ee(he.discreteChannelCannotEncode(e,"temporal")),"ordinal"):"time";case"quantitative":return X(e)?An(t.bin)?"bin-ordinal":"linear":"discrete"===ce(e)?(Ee(he.discreteChannelCannotEncode(e,"quantitative")),"ordinal"):"linear";case"geojson":return}throw new Error(he.invalidFieldType(t.type))}(t,n,r),{type:o}=e;return ae(t)?void 0!==o?We(t,o)?Be(o,n.type)?o:(Ee(he.scaleTypeNotWorkWithFieldDef(o,i)),i):(Ee(he.scaleTypeNotWorkWithChannel(t,o,i)),i):i:null}function Bn(e){return e===Se||e===Ae||e===Ln.KEY}!function(e){e.QUANTITATIVE=Te,e.ORDINAL=Se,e.TEMPORAL=Ce,e.NOMINAL=Ae,e.KEY="key"}(Ln||(Ln={}));class Wn{constructor(e=null){this.index=e?Object.assign({},e):{}}has(e){return St(e)in this.index}get(e){return this.index[St(e)]}set(e,t){return this.index[St(e)]=t,this}setByKey(e,t){this.index[e]=t}map(e){const t=new Wn;for(const n in this.index)t.index[n]=e(this.index[n]);return t}size(){return qe(this.index).length}duplicate(){return new Wn(this.index)}}function Hn(e,t){const n=e&&e[t];return!!n&&(s(n)?function(e,t){let n=0;for(const[r,i]of e.entries())if(t(i,r,n++))return!0;return!1}(n,e=>!!e.field):xn(n)||On(n))}const Gn={zero:1,center:1,normalize:1};const jn=[Ut,kt,"rule",Ft,Dt,_t,"line","text","tick"],zn=[Ut,kt];function qn(e,t,n,r={}){const i=function(e){return e.type}(e)?e.type:e;if(!T(jn,i))return null;const o=function(e){const t=e.x,n=e.y;if(xn(t)&&xn(n))if("quantitative"===t.type&&"quantitative"===n.type){if(t.stack)return"x";if(n.stack)return"y";if(!!t.aggregate!=!!n.aggregate)return t.aggregate?"x":"y"}else{if("quantitative"===t.type)return"x";if("quantitative"===n.type)return"y"}else{if(xn(t)&&"quantitative"===t.type)return"x";if(xn(n)&&"quantitative"===n.type)return"y"}}(t);if(!o)return null;const a=t[o],c=In(a)?Mn(a,{}):void 0,u="x"===o?"y":"x",l=t[u],d=In(l)?Mn(l,{}):void 0,f=ne.reduce((e,n)=>{if("tooltip"!==n&&Hn(t,n)){const r=t[n];(s(r)?r:[r]).forEach(t=>{const r=Dn(t);if(r.aggregate)return;const i=In(r)?Mn(r,{}):void 0;(!i||i!==d&&i!==c)&&e.push({channel:n,fieldDef:r})})}return e},[]);if(0===f.length)return null;let p;if(!(p=void 0!==a.stack?v(a.stack)?a.stack?"zero":null:a.stack:T(zn,i)?A(n,"zero"):n)||!Gn[p])return null;if(a.scale&&a.scale.type&&a.scale.type!==Oe.LINEAR){if(r.disallowNonLinearStack)return null;Ee(he.cannotStackNonLinearScale(a.scale.type))}return Hn(t,o===x?M:k)?(void 0!==a.stack&&Ee(he.cannotStackRangedMark(o)),null):(a.aggregate&&!T(Cn,a.aggregate)&&Ee(he.stackNonSummativeAggregate(a.aggregate)),{groupbyChannel:l?u:void 0,fieldChannel:o,impute:Pt(i),stackBy:f,offset:p})}function Yn(e){return Qe(e.data?{data:e.data}:{},e.transform?{transform:e.transform}:{},e.width?{width:e.width}:{},e.height?{height:e.height}:{},e.background?{background:e.background}:{},e.padding?{padding:e.padding}:{},e.title?{title:e.title}:{},{mark:e.mark,encodings:qe(e.encoding).map(t=>{let n={channel:t},r=e.encoding[t];for(const e in r)ut(e)&&void 0!==r[e]&&(Ze(["bin","scale","axis","legend"],e)&&null===r[e]?n[e]=!1:n[e]=r[e]);return gr(n)&&"count"===n.aggregate&&!n.field&&(n.field="*"),n})},e.config?{config:e.config}:{})}function Qn(e){return nt(e.encodings,e=>gr(e)&&!Zt(e.aggregate)&&!!e.aggregate||vr(e))}function Vn(e){if(!Xn(e))return null;const t=br(e.encodings,{schema:null,wildcardMode:"null"});return qn(e.mark,t,void 0,{disallowNonLinearStack:!0})}function Kn(e){for(const t of e.encodings)if(void 0!==t[It.STACK]&&!Zt(t[It.STACK]))return t[It.STACK]}function Jn(e){for(const t of e.encodings)if(void 0!==t[It.STACK]&&!Zt(t.channel))return t.channel;return null}function Xn(e){if(Zt(e.mark))return!1;const t=[It.STACK,It.CHANNEL,It.MARK,It.FIELD,It.AGGREGATE,It.AUTOCOUNT,It.SCALE,Nt("scale","type"),It.TYPE],n=Je(rt(Ot,t)),r=e.encodings.filter(e=>!yr(e));for(const e of r)if(Zn(e,{exclude:n}))return!1;return!0}function Zn(e,t={}){if(!Ve(e))return!1;for(const n in e)if(e.hasOwnProperty(n)){if(Zt(e[n])&&(!t.exclude||!t.exclude[n])||Zn(e[n],t))return!0}return!1}var er=Object.freeze({fromSpec:Yn,isAggregate:Qn,getVlStack:Vn,getStackOffset:Kn,getStackChannel:Jn,hasRequiredStackProperties:Xn,hasWildcard:function(e,t={}){const n=t.exclude?Je(t.exclude.map(St)):{};if(Zt(e.mark)&&!n.mark)return!0;for(const t of e.encodings)if(Zn(t,n))return!0;return!1}});function tr(e){return e.map(e=>nr(e))}function nr(e){return t=>void 0!==e[t]?e[t]:t}function rr(e,t){return Zt(e)?!en(e)&&e.enum?Xt+JSON.stringify(e.enum):Xt:t?t(e):e}function ir(e,t){return t?t(e):e}const or=new Wn,ar=[].concat(xt,gt,[It.TRANSFORM,It.STACK],bt).reduce((e,t)=>e.set(t,!0),new Wn);const sr={axis:{x:!0,y:!0,row:!0,column:!0},legend:{color:!0,opacity:!0,size:!0,shape:!0},scale:{x:!0,y:!0,color:!0,opacity:!0,row:!0,column:!0,size:!0,shape:!0},sort:{x:!0,y:!0,path:!0,order:!0},stack:{x:!0,y:!0}};function cr(e,t=ar,n=or){const r=[];let i;if(t.get(It.MARK)&&r.push(rr(e.mark,n.get(It.MARK))),e.transform&&e.transform.length>0&&r.push("transform:"+JSON.stringify(e.transform)),t.get(It.STACK)&&(i=Vn(e)),e.encodings){const o=e.encodings.reduce((e,r)=>{if(!yr(r)){let o;(o=i&&r.channel===i.fieldChannel?ur(Object.assign({},r,{stack:i.offset}),t,n):ur(r,t,n))&&e.push(o)}return e},[]).sort().join("|");o&&r.push(o)}for(let n of bt){const i=n.toString();if(t.get(n)&&e[i]){const t=e[i];r.push(`${i}=${JSON.stringify(t)}`)}}return r.join("|")}function ur(e,t=ar,n=or){const r=[];if(t.get(It.CHANNEL)&&r.push(rr(e.channel,n.get(It.CHANNEL))),gr(e)){const i=lr(e,t,n);i&&r.push(i)}else hr(e)?r.push(e.value):mr(e)&&r.push("autocount()");return r.join(":")}function lr(e,t=ar,n=or){if(t.get(It.AGGREGATE)&&yr(e))return"-";const r=function(e,t,n){if(t.get(It.AGGREGATE)&&e.aggregate&&!Zt(e.aggregate))return ir(e.aggregate,n.get(It.AGGREGATE));if(t.get(It.AGGREGATE)&&vr(e))return ir("count",n.get(It.AGGREGATE));if(t.get(It.TIMEUNIT)&&e.timeUnit&&!Zt(e.timeUnit))return ir(e.timeUnit,n.get(It.TIMEUNIT));if(t.get(It.BIN)&&e.bin&&!Zt(e.bin))return"bin";{let n=null;for(const r of[It.AGGREGATE,It.AUTOCOUNT,It.TIMEUNIT,It.BIN]){const i=e[r];t.get(r)&&e[r]&&Zt(i)&&((n=n||{})[r]=en(i)?i:i.enum)}return n&&e.hasFn&&(n.hasFn=!0),n}}(e,t,n),i=function(e,t,n){const r=[];if(!Ke(e.bin)&&!en(e.bin)){const i=e.bin;for(const e in i){const o=Nt("bin",e);o&&t.get(o)&&void 0!==i[e]&&r.push({key:e,value:rr(i[e],n.get(o))})}r.sort((e,t)=>e.key.localeCompare(t.key))}for(const i of[It.SCALE,It.SORT,It.STACK,It.AXIS,It.LEGEND])if((Zt(e.channel)||sr[i][e.channel])&&t.get(i)&&void 0!==e[i]){const o=e[i];if(Ke(o)||null===o)r.push({key:i+"",value:o||!1});else if(Xe(o))r.push({key:i+"",value:ir(JSON.stringify(o),n.get(i))});else{let e=[];for(const r in o){const a=Nt(i,r);a&&t.get(a)&&void 0!==o[r]&&e.push({key:r,value:rr(o[r],n.get(a))})}if(e.length>0){const t=e.sort((e,t)=>e.key.localeCompare(t.key)).reduce((e,t)=>(e[t.key]=t.value,e),{});r.push({key:i+"",value:JSON.stringify(t)})}}}return r}(e,t,n);let o;if(gr(e)){if(o=t.get("field")?rr(e.field,n.get("field")):"...",t.get(It.TYPE))if(Zt(e.type))o+=","+rr(e.type,n.get(It.TYPE));else{o+=","+rr(((e.type||Te)+"").substr(0,1),n.get(It.TYPE))}o+=i.map(e=>{let t=e.value instanceof Array?"["+e.value+"]":e.value;return","+e.key+"="+t}).join("")}else mr(e)&&(o="*,q");if(!o)return null;if(r){return(Xe(r)?r:Xt+(qe(r).length>0?JSON.stringify(r):""))+"("+o+")"}return o}function dr(e,t,n){let r=[],i=0;for(let o=0;o<n;o++){let n=e.indexOf(t,i);if(-1===n)break;r.push(e.substring(i,n)),i=n+1}if(r.push(e.substr(i)),r.length!==n+1)for(;r.length!==n+1;)r.push("");return r}var fr;!function(e){function t(e){const t={};t.field=e[0],t.type=we(e[1].toUpperCase())||"?";let r=e[2],i=0,o=0;for(;o<r.length;){let e,a=r.indexOf("=",o);if(-1===a)break;{let s=r.substring(o,a);if("{"===r[o+s.length+1]){let t=o+s.length+1;i=n(t,r,"}");const a=r.substring(t,i+1);e=JSON.parse(a),o=i+2}else if("["===r[o+s.length+1]){let t=o+s.length+1,i=n(t,r,"]");const a=r.substring(t,i+1);e=JSON.parse(a),o=i+2}else{let t=o,n=r.indexOf(",",o+s.length);-1===n&&(n=r.length),o=n+1,e=JSON.parse(r.substring(t+s.length+1,n))}dt(s)?t[s]=e:(t.bin=t.bin||{},t.bin[s]=e)}}return t}function n(e,t,n){for(let r=e;r<t.length;r++)if(t[r]===n)return r}function r(e){const r={};if("?"===e[0]){let i=n(1,e,"}"),o=JSON.parse(e.substring(1,i+1));for(let e in o)je(o[e])?r[e]={enum:o[e]}:r[e]=o[e];return Object.assign({},r,t(dr(e.substring(i+2,e.length-1),",",2)))}{let n=e.substring(0,e.indexOf("(")),r=dr(e.substring(n.length+1,e.length-1),",",2);if(Sn(n))return Object.assign({aggregate:n},t(r));if(Yt[n])return Object.assign({timeUnit:n},t(r));if("bin"===n)return Object.assign({bin:{}},t(r))}}e.encoding=function(e,n){let i=-1!==n.indexOf("(")?r(n):t(dr(n,",",2));return Object.assign({channel:e},i)},e.rawFieldDef=t,e.getClosingIndex=n,e.fn=r}(fr||(fr={}));var pr=Object.freeze({getReplacerIndex:tr,getReplacer:nr,value:rr,replace:ir,REPLACE_NONE:or,INCLUDE_ALL:ar,vlSpec:function(e,t=ar,n=or){return cr(Yn(e),t,n)},PROPERTY_SUPPORTED_CHANNELS:sr,spec:cr,encoding:ur,fieldDef:lr,parse:function(e){let t=e.split("|"),n={mark:t[0],encodings:[]};for(let e=1;e<t.length;e++){const r=dr(t[e],":",1),i=r[0],o=r[1];if(Z[i]||"?"===i){const e=fr.encoding(i,o);n.encodings.push(e)}else"transform"!==i||(n.transform=JSON.parse(o))}return n},splitWithTail:dr,get shorthandParser(){return fr}});function hr(e){return null!=e&&void 0!==e.value}function gr(e){return null!=e&&(e.field||"count"===e.aggregate)}function mr(e){return null!=e&&"autoCount"in e}function yr(e){return mr(e)&&!1===e.autoCount}function vr(e){return mr(e)&&!0===e.autoCount}const Er=[It.AGGREGATE,It.BIN,It.TIMEUNIT,It.FIELD,It.TYPE,It.SCALE,It.SORT,It.AXIS,It.LEGEND,It.STACK,It.FORMAT];function br(e,t){let n={};for(const r of e){if(yr(r))continue;const{channel:e}=r;if(Zt(e))throw new Error("Cannot convert wildcard channel to a fixed channel");const i=hr(r)?Tr(r):Sr(r,t);if(null!==i)n[e]=i;else if("null"===t.wildcardMode)return null}return n}function Tr(e){const{value:t}=e;return Zt(t)?null:{value:t}}function Sr(e,t={}){const{props:n=Er,schema:r,wildcardMode:i="skip"}=t;if(gr(e)){const t={};for(const o of n){let n=e[o];if(Zt(n)){if("skip"===i)continue;return null}if(void 0!==n){if(!(!sr[o]||sr[o][e.channel]))continue;if(dt(o)&&Ve(n)){n=Object.assign({},n);for(const e in n)if(Zt(n[e])){if("null"===i)return null;delete n[e]}}if("bin"===o&&!1===n)continue;"type"===o&&"key"===n?t.type="nominal":t[o]=n}if(o===It.SCALE&&r&&e.type===Se){const n=e.scale,{ordinalDomain:i}=r.fieldSchema(e.field);null!==n&&i&&(t[It.SCALE]=Object.assign({domain:i},Ve(n)?n:{}))}}return t}if(!1===e.autoCount)throw new Error("Cannot convert {autoCount: false} into a field def");return{aggregate:"count",field:"*",type:"quantitative"}}function Cr(e){return gr(e)?!Ar(e)&&"temporal"!==e.type:mr(e)}function Ar(e){if(gr(e)){const t=Sr(e,{props:["bin","timeUnit","type"]});return kn(t)||!!t.timeUnit}return!1}function Nr(e){const t=!0===e.scale||e.scale===Xt?{}:e.scale||{},{type:n,channel:r,timeUnit:i,bin:o}=e;if(Zt(t.type)||Zt(n)||Zt(r)||Zt(o))return;if(t.type)return t.type;if("temporal"===n&&Zt(i))return;if("quantitative"===n&&Zt(o))return;const a={type:n===Ln.KEY?"nominal":n,timeUnit:i,bin:o};return $n({type:t.type},r,a,void 0)}var wr=Object.freeze({isValueQuery:hr,isFieldQuery:gr,isAutoCountQuery:mr,isDisabledAutoCountQuery:yr,isEnabledAutoCountQuery:vr,toEncoding:br,toValueDef:Tr,toFieldDef:Sr,isContinuous:function(e){return gr(e)?Un(Sr(e,{props:["bin","timeUnit","field","type"]})):mr(e)},isMeasure:Cr,isDimension:Ar,scaleType:Nr}),Or=n(function(e,t){!function(e){var t=new Date,n=new Date;function r(e,i,o,a){function s(t){return e(t=new Date(+t)),t}return s.floor=s,s.round=function(t){var n=new Date(+t),r=new Date(t-1);return e(n),e(r),i(r,1),t-n<r-t?n:r},s.ceil=function(t){return e(t=new Date(t-1)),i(t,1),t},s.offset=function(e,t){return i(e=new Date(+e),null==t?1:Math.floor(t)),e},s.range=function(t,n,r){var o=[];if(t=new Date(t-1),n=new Date(+n),r=null==r?1:Math.floor(r),!(t<n&&r>0))return o;for(i(t,1),e(t),t<n&&o.push(new Date(+t));i(t,r),e(t),t<n;)o.push(new Date(+t));return o},s.filter=function(t){return r(function(n){for(;e(n),!t(n);)n.setTime(n-1)},function(e,n){for(;--n>=0;)for(;i(e,1),!t(e););})},o&&(s.count=function(r,i){return t.setTime(+r),n.setTime(+i),e(t),e(n),Math.floor(o(t,n))},s.every=function(e){return e=Math.floor(e),isFinite(e)&&e>0?e>1?s.filter(a?function(t){return a(t)%e==0}:function(t){return s.count(0,t)%e==0}):s:null}),s}var i=r(function(){},function(e,t){e.setTime(+e+t)},function(e,t){return t-e});i.every=function(e){return e=Math.floor(e),isFinite(e)&&e>0?e>1?r(function(t){t.setTime(Math.floor(t/e)*e)},function(t,n){t.setTime(+t+n*e)},function(t,n){return(n-t)/e}):i:null};var o=r(function(e){e.setMilliseconds(0)},function(e,t){e.setTime(+e+1e3*t)},function(e,t){return(t-e)/1e3},function(e){return e.getSeconds()}),a=r(function(e){e.setSeconds(0,0)},function(e,t){e.setTime(+e+6e4*t)},function(e,t){return(t-e)/6e4},function(e){return e.getMinutes()}),s=r(function(e){e.setMinutes(0,0,0)},function(e,t){e.setTime(+e+36e5*t)},function(e,t){return(t-e)/36e5},function(e){return e.getHours()}),c=r(function(e){e.setHours(0,0,0,0)},function(e,t){e.setDate(e.getDate()+t)},function(e,t){return(t-e-6e4*(t.getTimezoneOffset()-e.getTimezoneOffset()))/864e5},function(e){return e.getDate()-1});function u(e){return r(function(t){t.setHours(0,0,0,0),t.setDate(t.getDate()-(t.getDay()+7-e)%7)},function(e,t){e.setDate(e.getDate()+7*t)},function(e,t){return(t-e-6e4*(t.getTimezoneOffset()-e.getTimezoneOffset()))/6048e5})}var l=u(0),d=u(1),f=u(2),p=u(3),h=u(4),g=u(5),m=u(6),y=r(function(e){e.setHours(0,0,0,0),e.setDate(1)},function(e,t){e.setMonth(e.getMonth()+t)},function(e,t){return t.getMonth()-e.getMonth()+12*(t.getFullYear()-e.getFullYear())},function(e){return e.getMonth()}),v=r(function(e){e.setHours(0,0,0,0),e.setMonth(0,1)},function(e,t){e.setFullYear(e.getFullYear()+t)},function(e,t){return t.getFullYear()-e.getFullYear()},function(e){return e.getFullYear()}),E=r(function(e){e.setUTCMilliseconds(0)},function(e,t){e.setTime(+e+1e3*t)},function(e,t){return(t-e)/1e3},function(e){return e.getUTCSeconds()}),b=r(function(e){e.setUTCSeconds(0,0)},function(e,t){e.setTime(+e+6e4*t)},function(e,t){return(t-e)/6e4},function(e){return e.getUTCMinutes()}),T=r(function(e){e.setUTCMinutes(0,0,0)},function(e,t){e.setTime(+e+36e5*t)},function(e,t){return(t-e)/36e5},function(e){return e.getUTCHours()}),S=r(function(e){e.setUTCHours(0,0,0,0)},function(e,t){e.setUTCDate(e.getUTCDate()+t)},function(e,t){return(t-e)/864e5},function(e){return e.getUTCDate()-1});function C(e){return r(function(t){t.setUTCHours(0,0,0,0),t.setUTCDate(t.getUTCDate()-(t.getUTCDay()+7-e)%7)},function(e,t){e.setUTCDate(e.getUTCDate()+7*t)},function(e,t){return(t-e)/6048e5})}var A=C(0),N=C(1),w=C(2),O=C(3),x=C(4),I=C(5),M=C(6),k=r(function(e){e.setUTCHours(0,0,0,0),e.setUTCDate(1)},function(e,t){e.setUTCMonth(e.getUTCMonth()+t)},function(e,t){return t.getUTCMonth()-e.getUTCMonth()+12*(t.getUTCFullYear()-e.getUTCFullYear())},function(e){return e.getUTCMonth()}),U=r(function(e){e.setUTCHours(0,0,0,0),e.setUTCMonth(0,1)},function(e,t){e.setUTCFullYear(e.getUTCFullYear()+t)},function(e,t){return t.getUTCFullYear()-e.getUTCFullYear()},function(e){return e.getUTCFullYear()}),F=i.range,D=o.range,_=a.range,P=s.range,R=c.range,L=l.range,$=d.range,B=f.range,W=p.range,H=h.range,G=g.range,j=m.range,z=l.range,q=y.range,Y=v.range,Q=i,V=F,K=E.range,J=b.range,X=T.range,Z=S.range,ee=A.range,te=N.range,ne=w.range,re=O.range,ie=x.range,oe=I.range,ae=M.range,se=A.range,ce=k.range,ue=U.range;e.version="0.1.1",e.milliseconds=F,e.seconds=D,e.minutes=_,e.hours=P,e.days=R,e.sundays=L,e.mondays=$,e.tuesdays=B,e.wednesdays=W,e.thursdays=H,e.fridays=G,e.saturdays=j,e.weeks=z,e.months=q,e.years=Y,e.utcMillisecond=Q,e.utcMilliseconds=V,e.utcSeconds=K,e.utcMinutes=J,e.utcHours=X,e.utcDays=Z,e.utcSundays=ee,e.utcMondays=te,e.utcTuesdays=ne,e.utcWednesdays=re,e.utcThursdays=ie,e.utcFridays=oe,e.utcSaturdays=ae,e.utcWeeks=se,e.utcMonths=ce,e.utcYears=ue,e.millisecond=i,e.second=o,e.minute=a,e.hour=s,e.day=c,e.sunday=l,e.monday=d,e.tuesday=f,e.wednesday=p,e.thursday=h,e.friday=g,e.saturday=m,e.week=l,e.month=y,e.year=v,e.utcSecond=E,e.utcMinute=b,e.utcHour=T,e.utcDay=S,e.utcSunday=A,e.utcMonday=N,e.utcTuesday=w,e.utcWednesday=O,e.utcThursday=x,e.utcFriday=I,e.utcSaturday=M,e.utcWeek=A,e.utcMonth=k,e.utcYear=U,e.interval=r}(t)}),xr=new Date,Ir=new Date(0,0,1).setFullYear(0),Mr=new Date(Date.UTC(0,0,1)).setUTCFullYear(0);function kr(e){return xr.setTime(+e),xr}function Ur(e,t,n,r,i,o){var a={type:e,date:t,unit:n};return r?a.step=r:a.minstep=1,null!=i&&(a.min=i),null!=o&&(a.max=o),a}function Fr(e,t,n,r,i,o){return Ur(e,function(e){return t.offset(n,e)},function(e){return t.count(n,e)},r,i,o)}var Dr=[Fr("second",Or.second,Ir),Fr("minute",Or.minute,Ir),Fr("hour",Or.hour,Ir),Fr("day",Or.day,Ir,[1,7]),Fr("month",Or.month,Ir,[1,3,6]),Fr("year",Or.year,Ir),Ur("seconds",function(e){return new Date(1970,0,1,0,0,e)},function(e){return kr(e).getSeconds()},null,0,59),Ur("minutes",function(e){return new Date(1970,0,1,0,e)},function(e){return kr(e).getMinutes()},null,0,59),Ur("hours",function(e){return new Date(1970,0,1,e)},function(e){return kr(e).getHours()},null,0,23),Ur("weekdays",function(e){return new Date(1970,0,4+e)},function(e){return kr(e).getDay()},[1],0,6),Ur("dates",function(e){return new Date(1970,0,e)},function(e){return kr(e).getDate()},[1],1,31),Ur("months",function(e){return new Date(1970,e%12,1)},function(e){return kr(e).getMonth()},[1],0,11)],_r=[Fr("second",Or.utcSecond,Mr),Fr("minute",Or.utcMinute,Mr),Fr("hour",Or.utcHour,Mr),Fr("day",Or.utcDay,Mr,[1,7]),Fr("month",Or.utcMonth,Mr,[1,3,6]),Fr("year",Or.utcYear,Mr),Ur("seconds",function(e){return new Date(Date.UTC(1970,0,1,0,0,e))},function(e){return kr(e).getUTCSeconds()},null,0,59),Ur("minutes",function(e){return new Date(Date.UTC(1970,0,1,0,e))},function(e){return kr(e).getUTCMinutes()},null,0,59),Ur("hours",function(e){return new Date(Date.UTC(1970,0,1,e))},function(e){return kr(e).getUTCHours()},null,0,23),Ur("weekdays",function(e){return new Date(Date.UTC(1970,0,4+e))},function(e){return kr(e).getUTCDay()},[1],0,6),Ur("dates",function(e){return new Date(Date.UTC(1970,0,e))},function(e){return kr(e).getUTCDate()},[1],1,31),Ur("months",function(e){return new Date(Date.UTC(1970,e%12,1))},function(e){return kr(e).getUTCMonth()},[1],0,11)],Pr=[[31536e6,5],[7776e6,4],[2592e6,4],[12096e5,3],[6048e5,3],[1728e5,3],[864e5,3],[432e5,2],[216e5,2],[108e5,2],[36e5,2],[18e5,1],[9e5,1],[3e5,1],[6e4,1],[3e4,0],[15e3,0],[5e3,0],[1e3,0]];function Rr(e){var t,n,r={};for(t=0,n=e.length;t<n;++t)r[e[t].type]=e[t];return r.find=function(t,n,r){return function(e,t,n,r){var i,o,a,s=Pr[0];for(i=1,o=Pr.length;i<o;++i)if(t>(s=Pr[i])[0]){if((a=t/s[0])>r)return e[Pr[i-1][1]];if(a>=n)return e[s[1]]}return e[Pr[o-1][1]]}(e,t,n,r)},r}var Lr=Rr(Dr),$r=Rr(_r);Lr.utc=$r;var Br=1e-15;function Wr(e){if(!e)throw Error("Missing binning options.");var t,n,r,i,o,a,s,c=e.maxbins||15,u=e.base||10,l=Math.log(u),d=e.div||[5,2],f=e.min,p=e.max,h=p-f;if(e.step)t=e.step;else if(e.steps)t=e.steps[Math.min(e.steps.length-1,function(e,t,n,r){for(;n<r;){var i=n+r>>>1;Ge.cmp(e[i],t)<0?n=i+1:r=i}return n}(e.steps,h/c,0,e.steps.length))];else{for(n=Math.ceil(Math.log(c)/l),r=e.minstep||0,t=Math.max(r,Math.pow(u,Math.round(Math.log(h)/l)-n));Math.ceil(h/t)>c;)t*=u;for(a=0;a<d.length;++a)(o=t/d[a])>=r&&h/o<=c&&(t=o)}return i=(o=Math.log(t))>=0?0:1+~~(-o/l),s=Math.pow(u,-i-1),{start:f=Math.min(f,Math.floor(f/t+s)*t),stop:p=Math.ceil(p/t)*t,step:t,unit:{precision:i},value:Hr,index:Gr}}function Hr(e){return this.step*Math.floor(e/this.step+Br)}function Gr(e){return Math.floor((e-this.start)/this.step+Br)}function jr(e){return this.unit.date(Hr.call(this,e))}function zr(e){return Gr.call(this,this.unit.unit(e))}Wr.date=function(e){if(!e)throw Error("Missing date binning options.");var t=e.utc?Lr.utc:Lr,n=e.min,r=e.max,i=e.maxbins||20,o=e.minbins||4,a=+r-+n,s=e.unit?t[e.unit]:t.find(a,o,i),c=Wr({min:null!=s.min?s.min:s.unit(n),max:null!=s.max?s.max:s.unit(r),maxbins:i,minstep:s.minstep,steps:s.step});return c.unit=s,c.index=zr,e.raw||(c.value=jr),c};var qr=Wr,Yr="__types__",Qr={boolean:Ge.boolean,integer:Ge.number,number:Ge.number,date:Ge.date,string:function(e){return null==e||""===e?null:e+""}},Vr={boolean:function(e){return"true"===e||"false"===e||Ge.isBoolean(e)},integer:function(e){return Vr.number(e)&&(e=+e)==~~e},number:function(e){return!isNaN(+e)&&!Ge.isDate(e)},date:function(e){return!isNaN(Date.parse(e))}};function Kr(e){return Ge.keys(e)}function Jr(e){return"["+e+"]"}function Xr(e,t){var n,r,i;if(e=Ge.array(e),t=Ge.$(t),e[Yr]&&(n=t(e[Yr]),Ge.isString(n)))return n;for(r=0,i=e.length;!Ge.isValid(n)&&r<i;++r)n=t?t(e[r]):e[r];return Ge.isDate(n)?"date":Ge.isNumber(n)?"number":Ge.isBoolean(n)?"boolean":Ge.isString(n)?"string":null}function Zr(e,t){var n,r,i;e=Ge.array(e),t=Ge.$(t);var o=["boolean","integer","number","date"];for(n=0;n<e.length;++n){for(i=t?t(e[n]):e[n],r=0;r<o.length;++r)Ge.isValid(i)&&!Vr[o[r]](i)&&(o.splice(r,1),r-=1);if(0===o.length)return"string"}return o[0]}Xr.annotation=function(e,t){if(!t)return e&&e[Yr]||null;e[Yr]=t},Xr.all=function(e,t){if(e.length){var n=t?Ge.identity:(t=Kr(e[0]),Jr);return t.reduce(function(t,r){return t[r]=Xr(e,n(r)),t},{})}},Xr.infer=Zr,Xr.inferAll=function(e,t){var n=t?Ge.identity:(t=Kr(e[0]),Jr);return t.reduce(function(t,r){return t[r]=Zr(e,n(r)),t},{})},Xr.parsers=Qr;var ei=Xr,ti=ei.inferAll,ni=n(function(e){var t=e.exports;t.repeat=function(e,t){var n,r=Array(t);for(n=0;n<t;++n)r[n]=e;return r},t.zeros=function(e){return t.repeat(0,e)},t.range=function(e,t,n){if(arguments.length<3&&(n=1,arguments.length<2&&(t=e,e=0)),(t-e)/n==1/0)throw new Error("Infinite range");var r,i=[],o=-1;if(n<0)for(;(r=e+n*++o)>t;)i.push(r);else for(;(r=e+n*++o)<t;)i.push(r);return i},t.random={},t.random.uniform=function(e,n){void 0===n&&(n=void 0===e?1:e,e=0);var r=n-e,i=function(){return e+r*Math.random()};return i.samples=function(e){return t.zeros(e).map(i)},i.pdf=function(t){return t>=e&&t<=n?1/r:0},i.cdf=function(t){return t<e?0:t>n?1:(t-e)/r},i.icdf=function(t){return t>=0&&t<=1?e+t*r:NaN},i},t.random.integer=function(e,n){void 0===n&&(n=e,e=0);var r=n-e,i=function(){return e+Math.floor(r*Math.random())};return i.samples=function(e){return t.zeros(e).map(i)},i.pdf=function(t){return t===Math.floor(t)&&t>=e&&t<n?1/r:0},i.cdf=function(t){var i=Math.floor(t);return i<e?0:i>=n?1:(i-e+1)/r},i.icdf=function(t){return t>=0&&t<=1?e-1+Math.floor(t*r):NaN},i},t.random.normal=function(e,n){var r;e=e||0,n=n||1;var i=function(){var t,i,o=0,a=0;if(void 0!==r)return o=r,r=void 0,o;do{t=(o=2*Math.random()-1)*o+(a=2*Math.random()-1)*a}while(0===t||t>1);return i=Math.sqrt(-2*Math.log(t)/t),r=e+a*i*n,e+o*i*n};return i.samples=function(e){return t.zeros(e).map(i)},i.pdf=function(t){var r=Math.exp(Math.pow(t-e,2)/(-2*Math.pow(n,2)));return 1/(n*Math.sqrt(2*Math.PI))*r},i.cdf=function(t){var r,i=(t-e)/n,o=Math.abs(i);if(o>37)r=0;else{var a=Math.exp(-o*o/2);o<7.07106781186547?(r=a*((((((.0352624965998911*o+.700383064443688)*o+6.37396220353165)*o+33.912866078383)*o+112.079291497871)*o+221.213596169931)*o+220.206867912376),r/=((((((.0883883476483184*o+1.75566716318264)*o+16.064177579207)*o+86.7807322029461)*o+296.564248779674)*o+637.333633378831)*o+793.826512519948)*o+440.413735824752):r=a/(o+1/(o+2/(o+3/(o+4/(o+.65)))))/2.506628274631}return i>0?1-r:r},i.icdf=function(t){if(t<=0||t>=1)return NaN;var r=2*t-1,i=8*(Math.PI-3)/(3*Math.PI*(4-Math.PI)),o=2/(Math.PI*i)+Math.log(1-Math.pow(r,2))/2,a=Math.log(1-r*r)/i,s=(r>0?1:-1)*Math.sqrt(Math.sqrt(o*o-a)-o);return e+n*Math.SQRT2*s},i},t.random.bootstrap=function(e,n){var r=e.filter(Ge.isValid),i=r.length,o=n?t.random.normal(0,n):null,a=function(){return r[~~(Math.random()*i)]+(o?o():0)};return a.samples=function(e){return t.zeros(e).map(a)},a}}),ri=n(function(e){var t=e.exports;function n(e,n,r){var i=e&&e.nullh||0,o=ni.random.normal(0,1),a=t.mean(n,r),s=t.stdev(n,r)/Math.sqrt(t.count.valid(n,r));if(0===s)return a-i==0?1:0;var c=(a-i)/s;return 2*o.cdf(-Math.abs(c))}function r(e,n,r,i){var o,a=i?n.map(Ge.$(r)):n,s=i?n.map(Ge.$(i)):r,c=t.count(a),u=t.count(s),l=Array();if(c!==u)throw Error("Array lengths must match.");for(o=0;o<c;++o)Ge.isValid(a[o])&&Ge.isValid(s[o])&&l.push(a[o]-s[o]);return t.z.test(l,e&&e.nullh||0)}function i(e,n,r,i){var o=i?n.map(Ge.$(r)):n,a=i?n.map(Ge.$(i)):r,s=t.count.valid(o),c=t.count.valid(a),u=ni.random.normal(0,1),l=t.mean(o)-t.mean(a)-(e&&e.nullh||0),d=Math.sqrt(t.variance(o)/s+t.variance(a)/c);if(0===d)return 0===l?1:0;var f=l/d;return 2*u.cdf(-Math.abs(f))}t.unique=function(e,t,n){t=Ge.$(t),n=n||[];var r,i,o,a={};for(i=0,o=e.length;i<o;++i)(r=t?t(e[i]):e[i])in a||(a[r]=1,n.push(r));return n},t.count=function(e){return e&&e.length||0},t.count.valid=function(e,t){t=Ge.$(t);var n,r,i,o=0;for(r=0,i=e.length;r<i;++r)n=t?t(e[r]):e[r],Ge.isValid(n)&&(o+=1);return o},t.count.missing=function(e,t){t=Ge.$(t);var n,r,i=0;for(n=0,r=e.length;n<r;++n)null==(t?t(e[n]):e[n])&&(i+=1);return i},t.count.distinct=function(e,t){t=Ge.$(t);var n,r,i,o={},a=0;for(r=0,i=e.length;r<i;++r)(n=t?t(e[r]):e[r])in o||(o[n]=1,a+=1);return a},t.count.map=function(e,t){t=Ge.$(t);var n,r,i,o={};for(r=0,i=e.length;r<i;++r)o[n=t?t(e[r]):e[r]]=n in o?o[n]+1:1;return o},t.median=function(e,n){return n&&(e=e.map(Ge.$(n))),e=e.filter(Ge.isValid).sort(Ge.cmp),t.quantile(e,.5)},t.quartile=function(e,n){n&&(e=e.map(Ge.$(n))),e=e.filter(Ge.isValid).sort(Ge.cmp);var r=t.quantile;return[r(e,.25),r(e,.5),r(e,.75)]},t.quantile=function(e,t,n){void 0===n&&(n=t,t=Ge.identity),t=Ge.$(t);var r=(e.length-1)*n+1,i=Math.floor(r),o=+t(e[i-1]),a=r-i;return a?o+a*(t(e[i])-o):o},t.sum=function(e,t){t=Ge.$(t);for(var n,r=0,i=0,o=e.length;i<o;++i)n=t?t(e[i]):e[i],Ge.isValid(n)&&(r+=n);return r},t.mean=function(e,t){t=Ge.$(t);var n,r,i,o,a=0;for(n=0,i=0,r=e.length;n<r;++n)o=t?t(e[n]):e[n],Ge.isValid(o)&&(a+=(o-a)/++i);return a},t.mean.geometric=function(e,t){t=Ge.$(t);var n,r,i,o,a=1;for(o=0,n=0,r=e.length;o<r;++o)if(i=t?t(e[o]):e[o],Ge.isValid(i)){if(i<=0)throw Error("Geometric mean only defined for positive values.");a*=i,++n}return a=n>0?Math.pow(a,1/n):0},t.mean.harmonic=function(e,t){t=Ge.$(t);var n,r,i,o,a=0;for(o=0,n=0,r=e.length;o<r;++o)i=t?t(e[o]):e[o],Ge.isValid(i)&&(a+=1/i,++n);return n/a},t.variance=function(e,t){if(t=Ge.$(t),!Ge.isArray(e)||e.length<2)return 0;var n,r,i,o,a=0,s=0;for(r=0,i=0;r<e.length;++r)o=t?t(e[r]):e[r],Ge.isValid(o)&&(s+=(n=o-a)*(o-(a+=n/++i)));return s/=i-1},t.stdev=function(e,n){return Math.sqrt(t.variance(e,n))},t.modeskew=function(e,n){var r=t.mean(e,n),i=t.median(e,n),o=t.stdev(e,n);return 0===o?0:(r-i)/o},t.min=function(e,n){return t.extent(e,n)[0]},t.max=function(e,n){return t.extent(e,n)[1]},t.extent=function(e,t){t=Ge.$(t);var n,r,i,o,a=e.length;for(o=0;o<a;++o)if(i=t?t(e[o]):e[o],Ge.isValid(i)){n=r=i;break}for(;o<a;++o)i=t?t(e[o]):e[o],Ge.isValid(i)&&(i<n&&(n=i),i>r&&(r=i));return[n,r]},t.extent.index=function(e,t){t=Ge.$(t);var n,r,i,o,a=-1,s=-1,c=e.length;for(o=0;o<c;++o)if(i=t?t(e[o]):e[o],Ge.isValid(i)){n=r=i,a=s=o;break}for(;o<c;++o)i=t?t(e[o]):e[o],Ge.isValid(i)&&(i<n&&(n=i,a=o),i>r&&(r=i,s=o));return[a,s]},t.dot=function(e,t,n){var r,i,o=0;if(n)for(t=Ge.$(t),n=Ge.$(n),r=0;r<e.length;++r)(i=t(e[r])*n(e[r]))==i&&(o+=i);else{if(e.length!==t.length)throw Error("Array lengths must match.");for(r=0;r<e.length;++r)(i=e[r]*t[r])==i&&(o+=i)}return o},t.dist=function(e,t,n,r){var i,o,a=Ge.isFunction(n)||Ge.isString(n),s=e,c=a?e:t,u=a?r:n,l=2===u||null==u,d=e.length,f=0;for(a&&(t=Ge.$(t),n=Ge.$(n)),o=0;o<d;++o)i=a?t(s[o])-n(c[o]):s[o]-c[o],f+=l?i*i:Math.pow(Math.abs(i),u);return l?Math.sqrt(f):Math.pow(f,1/u)},t.cohensd=function(e,n,r){var i=r?e.map(Ge.$(n)):e,o=r?e.map(Ge.$(r)):n,a=t.mean(i),s=t.mean(o),c=t.count.valid(i),u=t.count.valid(o);if(c+u-2<=0)return 0;var l=t.variance(i),d=t.variance(o),f=Math.sqrt(((c-1)*l+(u-1)*d)/(c+u-2));return 0===f?0:(a-s)/f},t.covariance=function(e,n,r){var i,o,a,s,c,u=r?e.map(Ge.$(n)):e,l=r?e.map(Ge.$(r)):n,d=u.length,f=t.mean(u),p=t.mean(l),h=0,g=0;if(d!==l.length)throw Error("Input lengths must match.");for(i=0;i<d;++i)if(o=u[i],s=Ge.isValid(o),a=l[i],c=Ge.isValid(a),s&&c)h+=(o-f)*(a-p),++g;else if(s||c)throw Error("Valid values must align.");return h/(g-1)},t.rank=function(e,t){t=Ge.$(t)||Ge.identity;var n,r,i,o=e.map(function(e,n){return{idx:n,val:t(e)}}).sort(Ge.comparator("val")),a=e.length,s=Array(a),c=-1,u={};for(n=0;n<a;++n){if(r=o[n].val,c<0&&u===r)c=n-1;else if(c>-1&&u!==r){for(i=1+(n-1+c)/2;c<n;++c)s[o[c].idx]=i;c=-1}s[o[n].idx]=n+1,u=r}if(c>-1)for(i=1+(a-1+c)/2;c<a;++c)s[o[c].idx]=i;return s},t.cor=function(e,n,r){var i=r;r=i?e.map(Ge.$(r)):n,n=i?e.map(Ge.$(n)):e;var o=t.dot(n,r),a=t.mean(n),s=t.mean(r),c=t.stdev(n),u=t.stdev(r),l=e.length;return(o-l*a*s)/((l-1)*c*u)},t.cor.rank=function(e,n,r){var i,o,a,s=r?t.rank(e,n):t.rank(e),c=r?t.rank(e,r):t.rank(n),u=e.length;for(i=0,o=0;i<u;++i)o+=(a=s[i]-c[i])*a;return 1-6*o/(u*(u*u-1))},t.cor.dist=function(e,n,r){var i,o,a,s,c=r?e.map(Ge.$(n)):e,u=r?e.map(Ge.$(r)):n,l=t.dist.mat(c),d=t.dist.mat(u),f=l.length;for(i=0,o=0,a=0,s=0;i<f;++i)o+=l[i]*l[i],a+=d[i]*d[i],s+=l[i]*d[i];return Math.sqrt(s/Math.sqrt(o*a))},t.linearRegression=function(e,n,r){var i,o,a=r?e.map(Ge.$(n)):e,s=r?e.map(Ge.$(r)):n,c=a.length,u=t.covariance(a,s),l=t.stdev(a),d=t.stdev(s),f=u/(l*l),p=t.mean(s)-f*t.mean(a),h={slope:f,intercept:p,R:u/(l*d),rss:0};for(o=0;o<c;++o)Ge.isValid(a[o])&&Ge.isValid(s[o])&&(i=f*a[o]+p-s[o],h.rss+=i*i);return h},t.bootstrap={},t.bootstrap.ci=function(e,n,r,i,o){var a,s,c,u,l,d,f;for(Ge.isFunction(n)||Ge.isString(n)?(a=e.map(Ge.$(n)),s=r,c=i,u=o):(a=e,s=n,c=r,u=i),s=s?+s:1e3,c=c||.05,l=ni.random.bootstrap(a,u),f=0,d=Array(s);f<s;++f)d[f]=t.mean(l.samples(a.length));return d.sort(Ge.numcmp),[t.quantile(d,c/2),t.quantile(d,1-c/2)]},t.z={},t.z.ci=function(e,n,r){var i=e,o=n;(Ge.isFunction(n)||Ge.isString(n))&&(i=e.map(Ge.$(n)),o=r);var a=.05===(o=o||.05)?1.96:ni.random.normal(0,1).icdf(1-o/2),s=t.mean(i),c=t.stdev(i)/Math.sqrt(t.count.valid(i));return[s-a*c,s+a*c]},t.z.test=function(e,t,o,a){return Ge.isFunction(o)||Ge.isString(o)?(a&&a.paired?r:i)(a,e,t,o):Ge.isArray(t)?(o&&o.paired?r:i)(o,e,t):Ge.isFunction(t)||Ge.isString(t)?n(o,e,t):n(t,e)},t.dist.mat=function(e){var t,n,r,i=e.length,o=i*i,a=Array(o),s=ni.zeros(i),c=0;for(n=0;n<i;++n)for(a[n*i+n]=0,r=n+1;r<i;++r)a[n*i+r]=t=Math.abs(e[n]-e[r]),a[r*i+n]=t,s[n]+=t,s[r]+=t;for(n=0;n<i;++n)c+=s[n],s[n]/=i;for(c/=o,n=0;n<i;++n)for(r=n;r<i;++r)a[n*i+r]+=c-s[n]-s[r],a[r*i+n]=a[n*i+r];return a},t.entropy=function(e,t){t=Ge.$(t);var n,r,i=0,o=0,a=e.length;for(n=0;n<a;++n)i+=t?t(e[n]):e[n];if(0===i)return 0;for(n=0;n<a;++n)(r=(t?t(e[n]):e[n])/i)&&(o+=r*Math.log(r));return-o/Math.LN2},t.mutual=function(e,t,n,r){var i,o,a,s=r?e.map(Ge.$(t)):e,c=r?e.map(Ge.$(n)):t,u=r?e.map(Ge.$(r)):n,l={},d={},f=u.length,p=0,h=0,g=0;for(a=0;a<f;++a)l[s[a]]=0,d[c[a]]=0;for(a=0;a<f;++a)l[s[a]]+=u[a],d[c[a]]+=u[a],p+=u[a];for(o=1/(p*Math.LN2),a=0;a<f;++a)0!==u[a]&&(i=p*u[a]/(l[s[a]]*d[c[a]]),h+=u[a]*o*Math.log(i),g+=u[a]*o*Math.log(u[a]/p));return[h,1+h/g]},t.mutual.info=function(e,n,r,i){return t.mutual(e,n,r,i)[0]},t.mutual.dist=function(e,n,r,i){return t.mutual(e,n,r,i)[1]},t.profile=function(e,n){var r,i,o,a,s,c=0,u=0,l=0,d=0,f=null,p=null,h=0,g=[],m={};for(o=0;o<e.length;++o)m[a=n?n(e[o]):e[o]]=a in m?m[a]+1:(d+=1,1),null==a?++l:Ge.isValid(a)&&(s="string"==typeof a?a.length:a,(null===f||s<f)&&(f=s),(null===p||s>p)&&(p=s),h+=(r=s-c)*(s-(c+=r/++u)),g.push(s));return h/=u-1,i=Math.sqrt(h),g.sort(Ge.cmp),{type:ei(e,n),unique:m,count:e.length,valid:u,missing:l,distinct:d,min:f,max:p,mean:c,stdev:i,median:a=t.quantile(g,.5),q1:t.quantile(g,.25),q3:t.quantile(g,.75),modeskew:0===i?0:(c-a)/i}},t.summary=function(e,n){var r=(n=n||Ge.keys(e[0])).map(function(n){var r=t.profile(e,Ge.$(n));return r.field=n,r});return r.__summary__=!0,r}}).summary;const ii=qr;const oi={nominal:0,key:1,ordinal:2,temporal:3,quantitative:4};class ai{constructor(e){this._tableSchema=e,e.fields.sort(function(e,t){return oi[e.vlType]<oi[t.vlType]?-1:oi[e.vlType]>oi[t.vlType]?1:e.name.localeCompare(t.name)}),e.fields.forEach((e,t)=>e.index=t),this._fieldSchemaIndex=e.fields.reduce((e,t)=>(e[t.name]=t,e),{})}fieldNames(){return this._tableSchema.fields.map(e=>e.name)}get fieldSchemas(){return this._tableSchema.fields}fieldSchema(e){return this._fieldSchemaIndex[e]}tableSchema(){const e=Ye(this._tableSchema);return e.fields.sort((e,t)=>e.originalIndex-t.originalIndex),e}primitiveType(e){return this._fieldSchemaIndex[e]?this._fieldSchemaIndex[e].type:null}vlType(e){return this._fieldSchemaIndex[e]?this._fieldSchemaIndex[e].vlType:null}cardinality(e,t=!0,n=!1){const r=this._fieldSchemaIndex[e.field];if(e.aggregate||mr(e)&&e.autoCount)return 1;if(e.bin){let t;const n=(t="boolean"==typeof e.bin?{maxbins:wn(e.channel)}:"?"===e.bin?{enum:[!0,!1]}:e.bin).maxbins;return r.binStats[n]||(r.binStats[n]=si(n,r.stats)),r.binStats[n].distinct}if(e.timeUnit){if(t)switch(e.timeUnit){case $t.SECONDS:case $t.MINUTES:return 60;case $t.HOURS:return 24;case $t.DAY:return 7;case $t.DATE:return 31;case $t.MONTH:return 12;case $t.QUARTER:return 4;case $t.MILLISECONDS:return 1e3}let i=e.timeUnit,o=r.timeStats;return o&&o[i]||(o=Object.assign({},o,{[i]:ci(e.timeUnit,r.stats)})),n?o[i].distinct-ui(o[i].unique,["Invalid Date",null]):o[i].distinct}return r?n?r.stats.distinct-ui(r.stats.unique,[NaN,null]):r.stats.distinct:null}timeUnitHasVariation(e){if(!e.timeUnit)return;if(e.timeUnit===$t.DAY){const t=Qe({},e,{timeUnit:$t.DATE});if(this.cardinality(t,!1,!0)<=1)return!1}let t=e.timeUnit;for(let n of Wt)if(Jt(t,n)){const t=Qe({},e,{timeUnit:n});if(this.cardinality(t,!1,!0)<=1)return!1}return!0}domain(e){const t=this._fieldSchemaIndex[e.field];let n=qe(t.stats.unique);return t.vlType===Te?[+t.stats.min,+t.stats.max]:t.type===li.DATETIME?[t.stats.min,t.stats.max]:t.type===li.INTEGER||t.type===li.NUMBER?(n=n.map(e=>+e)).sort(ze):t.vlType===Se&&t.ordinalDomain?t.ordinalDomain:n.map(e=>"null"===e?null:e).sort(ze)}stats(e){const t=this._fieldSchemaIndex[e.field];return t?t.stats:null}}function si(e,t){const n=ii({min:t.min,max:t.max,maxbins:e}),r=Qe({},t);return r.unique=function(e,t){const n={};for(let r in t){let i;i=null===r?null:isNaN(Number(r))?NaN:e.value(Number(r)),n[i]=(n[i]||0)+t[r]}return n}(n,t.unique),r.distinct=(n.stop-n.start)/n.step,r.min=n.start,r.max=n.stop,r}function ci(e,t){const n=Qe({},t);let r={};return qe(t.unique).forEach(function(n){let i,o="null"===n?null:new Date(n);i=null===o?null:isNaN(o.getTime())?"Invalid Date":(e===$t.DAY?o.getDay():Vt(e,o)).toString(),r[i]=(r[i]||0)+t.unique[n]}),n.unique=r,n.distinct=qe(r).length,n}function ui(e,t){return t.reduce(function(t,n){return e[n]?t+1:t},0)}var li;!function(e){e[e.STRING="string"]="STRING",e[e.NUMBER="number"]="NUMBER",e[e.INTEGER="integer"]="INTEGER",e[e.BOOLEAN="boolean"]="BOOLEAN",e[e.DATETIME="datetime"]="DATETIME"}(li||(li={}));var di=Object.freeze({build:function(e,t={},n={fields:[]}){t=Qe({},mn,t);let r=ri(e),i=ti(e),o=n.fields.reduce((e,t)=>(e[t.name]=t,e),{}),a=r.map(function(n,r){const a=n.field,s="date"===i[a]?li.DATETIME:i[a];let c,u=n.distinct;if(s===li.NUMBER)c=Te;else if(s===li.INTEGER)c=u<t.numberNominalLimit&&u/n.count<t.numberNominalProportion?Ae:Te;else if(s===li.DATETIME){c=Ce,n.min=new Date(e[0][a]),n.max=new Date(e[0][a]);for(const t of e){const e=new Date(t[a]).getTime();e<n.min.getTime()&&(n.min=new Date(e)),e>n.max.getTime()&&(n.max=new Date(e))}}else c=Ae;c===Ae&&u/n.count>t.minPercentUniqueForKey&&n.count>t.minCardinalityForKey&&(c=Ln.KEY);let l={name:a,originalIndex:r,vlType:c,type:s,stats:n,timeStats:{},binStats:{}};const d=o[l.name];return l=Qe(l,d)});for(let e of a)if(e.vlType===Te)for(let n of t.enum.binProps.maxbins)e.binStats[n]=si(n,e.stats);else if(e.vlType===Ce)for(let n of t.enum.timeUnit)void 0!==n&&(e.timeStats[n]=ci(n,e.stats));const s=Object.assign({},n,{fields:a});return new ai(s)},Schema:ai,get PrimitiveType(){return li}});class fi{constructor(e){this.constraint=e}name(){return this.constraint.name}description(){return this.constraint.description}properties(){return this.constraint.properties}strict(){return this.constraint.strict}}class pi extends fi{constructor(e){super(e)}hasAllRequiredPropertiesSpecific(e){return et(this.constraint.properties,t=>{if(at(t)){let n=t.parent,r=t.child;return!e[n]||!Zt(e[n][r])}return!e[t]||!Zt(e[t])})}satisfy(e,t,n,r){return!this.constraint.allowWildcardForProperties&&!this.hasAllRequiredPropertiesSpecific(e)||this.constraint.satisfy(e,t,n,r)}}const hi=[{name:"aggregateOpSupportedByType",description:"Aggregate function should be supported by data type.",properties:[It.TYPE,It.AGGREGATE],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n,r)=>!e.aggregate||!Bn(e.type)},{name:"asteriskFieldWithCountOnly",description:'Field="*" should be disallowed except aggregate="count"',properties:[It.FIELD,It.AGGREGATE],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n,r)=>"*"===e.field==("count"===e.aggregate)},{name:"minCardinalityForBin",description:"binned quantitative field should not have too low cardinality",properties:[It.BIN,It.FIELD,It.TYPE],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n,r)=>{if(e.bin&&e.type===Te){let n={channel:e.channel,field:e.field,type:e.type};return t.cardinality(n)>=r.minCardinalityForBin}return!0}},{name:"binAppliedForQuantitative",description:"bin should be applied to quantitative field only.",properties:[It.TYPE,It.BIN],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n,r)=>!e.bin||e.type===Te},{name:"channelFieldCompatible",description:"encoding channel's range type be compatible with channel type.",properties:[It.CHANNEL,It.TYPE,It.BIN,It.TIMEUNIT],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n,r)=>{const i=Object.assign({field:"f"},Sr(e,{schema:t,props:["bin","timeUnit","type"]})),{compatible:o}=Rn(i,e.channel);if(o)return!0;return!("row"!==e.channel&&"column"!==e.channel||!Ht(i.timeUnit)&&!jt(i.timeUnit))}},{name:"hasFn",description:"A field with as hasFn flag should have one of aggregate, timeUnit, or bin.",properties:[It.AGGREGATE,It.BIN,It.TIMEUNIT],allowWildcardForProperties:!0,strict:!0,satisfy:(e,t,n,r)=>!e.hasFn||(!!e.aggregate||!!e.bin||!!e.timeUnit)},{name:"omitScaleZeroWithBinnedField",description:"Do not use scale zero with binned field",properties:[It.SCALE,Nt("scale","zero"),It.BIN],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n,r)=>!e.bin||!e.scale||!0!==e.scale.zero},{name:"onlyOneTypeOfFunction",description:"Only of of aggregate, autoCount, timeUnit, or bin should be applied at the same time.",properties:[It.AGGREGATE,It.AUTOCOUNT,It.TIMEUNIT,It.BIN],allowWildcardForProperties:!0,strict:!0,satisfy:(e,t,n,r)=>{if(gr(e)){return(!Zt(e.aggregate)&&e.aggregate?1:0)+(!Zt(e.bin)&&e.bin?1:0)+(!Zt(e.timeUnit)&&e.timeUnit?1:0)<=1}return!0}},{name:"timeUnitAppliedForTemporal",description:"Time unit should be applied to temporal field only.",properties:[It.TYPE,It.TIMEUNIT],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n,r)=>!e.timeUnit||e.type===Ce},{name:"timeUnitShouldHaveVariation",description:"A particular time unit should be applied only if they produce unique values.",properties:[It.TIMEUNIT,It.TYPE],allowWildcardForProperties:!1,strict:!1,satisfy:(e,t,n,r)=>!e.timeUnit||e.type!==Ce||(!n.has("timeUnit")&&!r.constraintManuallySpecifiedValue||t.timeUnitHasVariation(e))},{name:"scalePropertiesSupportedByScaleType",description:"Scale properties must be supported by correct scale type",properties:[].concat(mt,[It.SCALE,It.TYPE]),allowWildcardForProperties:!0,strict:!0,satisfy:(e,t,n,r)=>{if(e.scale){const t=e.scale,n=Nr(e);if(null==n)return!0;for(let e in t){if("type"===e||"name"===e||"enum"===e)continue;const t=e;if("point"===n){if(!Le("point",t)&&!Le("band",t))return!1}else if(!Le(n,t))return!1}}return!0}},{name:"scalePropertiesSupportedByChannel",description:"Not all scale properties are supported by all encoding channels",properties:[].concat(mt,[It.SCALE,It.CHANNEL]),allowWildcardForProperties:!0,strict:!0,satisfy:(e,t,n,r)=>{if(e){let t=e.channel,n=e.scale;if(t&&!Zt(t)&&n){if("row"===t||"column"===t)return!1;for(let e in n){if(!n.hasOwnProperty(e))continue;if("type"===e||"name"===e||"enum"===e)continue;if(!(void 0===$e(t,e)))return!1}}}return!0}},{name:"typeMatchesPrimitiveType",description:"Data type should be supported by field's primitive type.",properties:[It.FIELD,It.TYPE],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n,r)=>{if("*"===e.field)return!0;const i=t.primitiveType(e.field),o=e.type;if(!n.has("field")&&!n.has("type")&&!r.constraintManuallySpecifiedValue)return!0;switch(i){case li.BOOLEAN:case li.STRING:return o!==Te&&o!==Ce;case li.NUMBER:case li.INTEGER:return o!==Ce;case li.DATETIME:return o===Ce;case null:return!1}throw new Error("Not implemented")}},{name:"typeMatchesSchemaType",description:"Enumerated data type of a field should match the field's type in the schema.",properties:[It.FIELD,It.TYPE],allowWildcardForProperties:!1,strict:!1,satisfy:(e,t,n,r)=>!(n.has("field")||n.has("type")||r.constraintManuallySpecifiedValue)||("*"===e.field?e.type===Te:t.vlType(e.field)===e.type)},{name:"maxCardinalityForCategoricalColor",description:"Categorical channel should not have too high cardinality",properties:[It.CHANNEL,It.FIELD],allowWildcardForProperties:!1,strict:!1,satisfy:(e,t,n,r)=>e.channel!==P||e.type!==Ae&&e.type!==Ln.KEY||t.cardinality(e)<=r.maxCardinalityForCategoricalColor},{name:"maxCardinalityForFacet",description:"Row/column channel should not have too high cardinality",properties:[It.CHANNEL,It.FIELD,It.BIN,It.TIMEUNIT],allowWildcardForProperties:!1,strict:!1,satisfy:(e,t,n,r)=>e.channel!==N&&e.channel!==w||t.cardinality(e)<=r.maxCardinalityForFacet},{name:"maxCardinalityForShape",description:"Shape channel should not have too high cardinality",properties:[It.CHANNEL,It.FIELD,It.BIN,It.TIMEUNIT],allowWildcardForProperties:!1,strict:!1,satisfy:(e,t,n,r)=>e.channel!==$||t.cardinality(e)<=r.maxCardinalityForShape},{name:"dataTypeAndFunctionMatchScaleType",description:"Scale type must match data type",properties:[It.TYPE,It.SCALE,Nt("scale","type"),It.TIMEUNIT,It.BIN],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n,r)=>{if(e.scale){const t=e.type,n=Nr(e);if(Bn(t))return void 0===n||De(n);if(t===Ce)return e.timeUnit?Ze([Oe.TIME,Oe.UTC,void 0],n)||De(n):Ze([Oe.TIME,Oe.UTC,void 0],n);if(t===Te)return e.bin?Ze([Oe.LINEAR,void 0],n):Ze([Oe.LOG,Oe.POW,Oe.SQRT,Oe.QUANTILE,Oe.QUANTIZE,Oe.LINEAR,void 0],n)}return!0}},{name:"stackIsOnlyUsedWithXY",description:"stack should only be allowed for x and y channels",properties:[It.STACK,It.CHANNEL],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n,r)=>!e.stack||(e.channel===x||e.channel===I)}].map(e=>new pi(e)),gi=(hi.reduce((e,t)=>(e[t.name()]=t,e),{}),hi.reduce((e,t)=>{for(const n of t.properties())e.set(n,e.get(n)||[]),e.get(n).push(t);return e},new Wn)),mi=[{name:"doesNotSupportConstantValue",description:"row, column, x, y, order, and detail should not work with constant values.",properties:[It.TYPE,It.AGGREGATE],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n,r)=>!Ze(["row","column","x","y","detail","order"],e.channel)}].map(e=>new pi(e)),yi=(mi.reduce((e,t)=>(e[t.name()]=t,e),{}),mi.reduce((e,t)=>{for(const n of t.properties())e.set(n,e.get(n)||[]),e.get(n).push(t);return e},new Wn));function vi(e,t,n,r,i,o){const a=gi.get(e)||[],s=r.getEncodingQueryByIndex(n);for(const e of a)if(e.strict()||o[e.name()]){if(!e.satisfy(s,i,r.wildcardIndex.encodings[n],o)){let n="(enc) "+e.name();return o.verbose&&console.log(n+" failed with "+r.toShorthand()+" for "+t.name),n}}const c=yi.get(e)||[];for(const e of c)if((e.strict()||o[e.name()])&&hr(s)){if(!e.satisfy(s,i,r.wildcardIndex.encodings[n],o)){let n="(enc) "+e.name();return o.verbose&&console.log(n+" failed with "+r.toShorthand()+" for "+t.name),n}}return null}var Ei=Object.freeze({checkEncoding:vi});const bi=ne.reduce((e,t)=>(e[t]=!0,e),{});class Ti extends fi{constructor(e){super(e)}hasAllRequiredPropertiesSpecific(e){return et(this.constraint.properties,t=>{if(t===It.MARK)return!Zt(e.getMark());if(at(t)){let n=t.parent,r=t.child;return et(e.getEncodings(),e=>!e[n]||!Zt(e[n][r]))}if(!wt(t))throw new Error("UNIMPLEMENTED");return et(e.getEncodings(),e=>!e[t]||!Zt(e[t]))})}satisfy(e,t,n){return!this.constraint.allowWildcardForProperties&&!this.hasAllRequiredPropertiesSpecific(e)||this.constraint.satisfy(e,t,n)}}const Si=[{name:"noRepeatedChannel",description:"Each encoding channel should only be used once.",properties:[It.CHANNEL],allowWildcardForProperties:!0,strict:!0,satisfy:(e,t,n)=>{let r={};return et(e.getEncodings(),e=>!!Zt(e.channel)||!r[e.channel]&&(r[e.channel]=!0,!0))}},{name:"alwaysIncludeZeroInScaleWithBarMark",description:"Do not recommend bar mark if scale does not start at zero",properties:[It.MARK,It.SCALE,Nt("scale","zero"),It.CHANNEL,It.TYPE],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n)=>{const r=e.getMark(),i=e.getEncodings();if(r===Ut)for(let e of i)if(gr(e)&&(e.channel===x||e.channel===I)&&e.type===Te&&e.scale&&!1===e.scale.zero)return!1;return!0}},{name:"autoAddCount",description:"Automatically adding count only for plots with only ordinal, binned quantitative, or temporal with timeunit fields.",properties:[It.BIN,It.TIMEUNIT,It.TYPE,It.AUTOCOUNT],allowWildcardForProperties:!0,strict:!1,satisfy:(e,t,n)=>{if(nt(e.getEncodings(),e=>vr(e)))return et(e.getEncodings(),e=>{if(hr(e))return!0;if(mr(e))return!0;switch(e.type){case Te:return!!e.bin;case Ce:return!!e.timeUnit;case Se:case Ln.KEY:case Ae:return!0}throw new Error("Unsupported Type")});if(et(e.wildcardIndex.encodingIndicesByProperty.get("autoCount")||[],t=>{let n=e.getEncodingQueryByIndex(t);return mr(n)&&!Zt(n.autoCount)}))return nt(e.getEncodings(),e=>(gr(e)||mr(e))&&e.type===Te?!yr(e)&&(gr(e)&&(!e.bin||Zt(e.bin))):!(!gr(e)||e.type!==Ce)&&(!e.timeUnit||Zt(e.timeUnit)));return!0}},{name:"channelPermittedByMarkType",description:"Each encoding channel should be supported by the mark type",properties:[It.CHANNEL,It.MARK],allowWildcardForProperties:!0,strict:!0,satisfy:(e,t,n)=>{const r=e.getMark();return!!Zt(r)||et(e.getEncodings(),e=>!!Zt(e.channel)||!!se(e.channel,r))}},{name:"hasAllRequiredChannelsForMark",description:"All required channels for the specified mark should be specified",properties:[It.CHANNEL,It.MARK],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n)=>{const r=e.getMark();switch(r){case kt:case"line":return e.channelUsed(x)&&e.channelUsed(I);case"text":return e.channelUsed(z);case Ut:case Dt:case _t:case"tick":case"rule":case"rect":return e.channelUsed(x)||e.channelUsed(I);case Ft:return!e.wildcardIndex.hasProperty(It.CHANNEL)||e.channelUsed(x)||e.channelUsed(I)}throw new Error("hasAllRequiredChannelsForMark not implemented for mark"+JSON.stringify(r))}},{name:"omitAggregate",description:"Omit aggregate plots.",properties:[It.AGGREGATE,It.AUTOCOUNT],allowWildcardForProperties:!0,strict:!1,satisfy:(e,t,n)=>!e.isAggregate()},{name:"omitAggregatePlotWithDimensionOnlyOnFacet",description:"Omit aggregate plots with dimensions only on facets as that leads to inefficient use of space.",properties:[It.CHANNEL,It.AGGREGATE,It.AUTOCOUNT],allowWildcardForProperties:!1,strict:!1,satisfy:(e,t,n)=>{if(e.isAggregate()){let t=!1,r=!1,i=!1;if(e.specQuery.encodings.forEach((n,o)=>{hr(n)||yr(n)||gr(n)&&!n.aggregate&&(r=!0,Ze([N,w],n.channel)?e.wildcardIndex.hasEncodingProperty(o,It.CHANNEL)&&(i=!0):t=!0)}),r&&!t&&(i||n.constraintManuallySpecifiedValue))return!1}return!0}},{name:"omitAggregatePlotWithoutDimension",description:"Aggregate plots without dimension should be omitted",properties:[It.AGGREGATE,It.AUTOCOUNT,It.BIN,It.TIMEUNIT,It.TYPE],allowWildcardForProperties:!1,strict:!1,satisfy:(e,t,n)=>!e.isAggregate()||nt(e.getEncodings(),e=>!!(Ar(e)||gr(e)&&"temporal"===e.type))},{name:"omitBarLineAreaWithOcclusion",description:"Don't use bar, line or area to visualize raw plot as they often lead to occlusion.",properties:[It.MARK,It.AGGREGATE,It.AUTOCOUNT],allowWildcardForProperties:!1,strict:!1,satisfy:(e,t,n)=>!Ze([Ut,"line",kt],e.getMark())||e.isAggregate()},{name:"omitBarTickWithSize",description:"Do not map field to size channel with bar and tick mark",properties:[It.CHANNEL,It.MARK],allowWildcardForProperties:!0,strict:!1,satisfy:(e,t,n)=>{const r=e.getMark();if(Ze(["tick",Ut],r)&&e.channelEncodingField(B)){if(n.constraintManuallySpecifiedValue)return!1;{const t=e.specQuery.encodings;for(let n=0;n<t.length;n++){if(t[n].channel===B)return!e.wildcardIndex.hasEncodingProperty(n,It.CHANNEL)}}}return!0}},{name:"omitBarAreaForLogScale",description:"Do not use bar and area mark for x and y's log scale",properties:[It.MARK,It.CHANNEL,It.SCALE,Nt("scale","type"),It.TYPE],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n)=>{const r=e.getMark(),i=e.getEncodings();if(r===kt||r===Ut)for(let e of i)if(gr(e)&&(e.channel===x||e.channel===I)&&e.scale){if(Nr(e)===Oe.LOG)return!1}return!0}},{name:"omitMultipleNonPositionalChannels",description:"Unless manually specified, do not use multiple non-positional encoding channel to avoid over-encoding.",properties:[It.CHANNEL],allowWildcardForProperties:!0,strict:!1,satisfy:(e,t,n)=>{const r=e.specQuery.encodings;let i=0,o=!1;for(let t=0;t<r.length;t++){const a=r[t];if(hr(a)||yr(a))continue;const s=a.channel;if(!Zt(s)&&bi[s+""]&&(i+=1,e.wildcardIndex.hasEncodingProperty(t,It.CHANNEL)&&(o=!0),i>1&&(o||n.constraintManuallySpecifiedValue)))return!1}return!0}},{name:"omitNonPositionalOrFacetOverPositionalChannels",description:"Do not use non-positional channels unless all positional channels are used",properties:[It.CHANNEL],allowWildcardForProperties:!1,strict:!1,satisfy:(e,t,n)=>{const r=e.specQuery.encodings;let i=!1,o=!1,a=!1,s=!1;for(let t=0;t<r.length;t++){const n=r[t];if(hr(n)||yr(n))continue;const c=n.channel;c===x?a=!0:c===I?s=!0:Zt(c)||(i=!0,e.wildcardIndex.hasEncodingProperty(t,It.CHANNEL)&&(o=!0))}return!(o||n.constraintManuallySpecifiedValue&&i)||a&&s}},{name:"omitRaw",description:"Omit raw plots.",properties:[It.AGGREGATE,It.AUTOCOUNT],allowWildcardForProperties:!1,strict:!1,satisfy:(e,t,n)=>!!e.isAggregate()},{name:"omitRawContinuousFieldForAggregatePlot",description:"Aggregate plot should not use raw continuous field as group by values. (Quantitative should be binned. Temporal should have time unit.)",properties:[It.AGGREGATE,It.AUTOCOUNT,It.TIMEUNIT,It.BIN,It.TYPE],allowWildcardForProperties:!0,strict:!1,satisfy:(e,t,n)=>{if(e.isAggregate()){const t=e.specQuery.encodings;for(let r=0;r<t.length;r++){const i=t[r];if(!hr(i)&&!yr(i)){if(gr(i)&&i.type===Ce&&!i.timeUnit&&(e.wildcardIndex.hasEncodingProperty(r,It.TIMEUNIT)||n.constraintManuallySpecifiedValue))return!1;if(i.type===Te&&gr(i)&&!i.bin&&!i.aggregate){if(e.wildcardIndex.hasEncodingProperty(r,It.BIN)||e.wildcardIndex.hasEncodingProperty(r,It.AGGREGATE)||e.wildcardIndex.hasEncodingProperty(r,It.AUTOCOUNT))return!1;if(n.constraintManuallySpecifiedValue)return!1}}}}return!0}},{name:"omitRawDetail",description:"Do not use detail channel with raw plot.",properties:[It.CHANNEL,It.AGGREGATE,It.AUTOCOUNT],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n)=>!!e.isAggregate()||et(e.specQuery.encodings,(t,r)=>!(!hr(t)&&!yr(t))||(t.channel!==Y||!e.wildcardIndex.hasEncodingProperty(r,It.CHANNEL)&&!n.constraintManuallySpecifiedValue))},{name:"omitRepeatedField",description:"Each field should be mapped to only one channel",properties:[It.FIELD],allowWildcardForProperties:!0,strict:!1,satisfy:(e,t,n)=>{let r={},i={};const o=e.specQuery.encodings;for(let t=0;t<o.length;t++){const a=o[t];if(hr(a)||mr(a))continue;let s;if(a.field&&!Zt(a.field)&&(s=a.field),mr(a)&&!Zt(a.autoCount)&&(s="count_*"),s){if(e.wildcardIndex.hasEncodingProperty(t,It.FIELD)&&(i[s]=!0),r[s]&&(i[s]||n.constraintManuallySpecifiedValue))return!1;r[s]=!0}}return!0}},{name:"omitVerticalDotPlot",description:"Do not output vertical dot plot.",properties:[It.CHANNEL],allowWildcardForProperties:!0,strict:!1,satisfy:(e,t,n)=>{const r=e.getEncodings();return 1!==r.length||r[0].channel!==I}},{name:"hasAppropriateGraphicTypeForMark",description:"Has appropriate graphic type for mark",properties:[It.CHANNEL,It.MARK,It.TYPE,It.TIMEUNIT,It.BIN,It.AGGREGATE,It.AUTOCOUNT],allowWildcardForProperties:!1,strict:!1,satisfy:(e,t,n)=>{const r=e.getMark();switch(r){case kt:case"line":if(e.isAggregate()){const t=e.getEncodingQueryByChannel(x),n=e.getEncodingQueryByChannel(I),r=Cr(t),i=Cr(n);return t&&n&&r!==i&&!(gr(t)&&!r&&Ze(["nominal","key"],t.type))&&!(gr(n)&&!i&&Ze(["nominal","key"],n.type))}return!0;case"text":return!0;case Ut:case"tick":if(e.channelEncodingField(B))return!1;{const t=e.getEncodingQueryByChannel(x),n=e.getEncodingQueryByChannel(I);return Cr(t)!==Cr(n)}case"rect":const t=e.getEncodingQueryByChannel(x),n=e.getEncodingQueryByChannel(I),i=Ar(t),o=Ar(n),a=e.getEncodingQueryByChannel(P),s=Cr(a),c=!!gr(a)&&a.type===Se,u=i&&o||i&&!e.channelUsed(I)||o&&!e.channelUsed(x),l=!a||a&&(s||c);return u&&l;case Dt:case Ft:case _t:case"rule":return!0}throw new Error("hasAllRequiredChannelsForMark not implemented for mark"+r)}},{name:"omitInvalidStackSpec",description:"If stack is specified, must follow Vega-Lite stack rules",properties:[It.STACK,It.FIELD,It.CHANNEL,It.MARK,It.AGGREGATE,It.AUTOCOUNT,It.SCALE,Nt("scale","type"),It.TYPE],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n)=>{if(!e.wildcardIndex.hasProperty(It.STACK))return!0;const r=e.getVlStack();return(null!==r||null===e.getStackOffset())&&r.fieldChannel===e.getStackChannel()}},{name:"omitNonSumStack",description:"Stack specifications that use non-summative aggregates should be omitted (even implicit ones)",properties:[It.CHANNEL,It.MARK,It.AGGREGATE,It.AUTOCOUNT,It.SCALE,Nt("scale","type"),It.TYPE],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n)=>{const r=e.getVlStack();if(null!=r){const t=e.getEncodingQueryByChannel(r.fieldChannel);if(!Ze(Cn,t.aggregate))return!1}return!0}},{name:"omitTableWithOcclusionIfAutoAddCount",description:"Plots without aggregation or autocount where x and y are both discrete should be omitted if autoAddCount is enabled as they often lead to occlusion",properties:[It.CHANNEL,It.TYPE,It.TIMEUNIT,It.BIN,It.AGGREGATE,It.AUTOCOUNT],allowWildcardForProperties:!1,strict:!1,satisfy:(e,t,n)=>{if(n.autoAddCount){const t=e.getEncodingQueryByChannel("x"),n=e.getEncodingQueryByChannel("y");if((!gr(t)||Ar(t))&&(!gr(n)||Ar(n)))return!!e.isAggregate()&&et(e.getEncodings(),e=>{let t=e.channel;return!(t!==x&&t!==I&&t!==N&&t!==w&&gr(e)&&!e.aggregate)})}return!0}}].map(e=>new Ti(e)),Ci=Si.reduce((e,t)=>(e[t.name()]=t,e),{}),Ai=Si.reduce((e,t)=>{for(const n of t.properties())e.set(n,e.get(n)||[]),e.get(n).push(t);return e},new Wn);function Ni(e,t,n,r,i){const o=Ai.get(e)||[];for(const e of o)if(e.strict()||i[e.name()]){if(!e.satisfy(n,r,i)){let r="(spec) "+e.name();return i.verbose&&console.log(r+" failed with "+n.toShorthand()+" for "+t.name),r}}return null}var wi=Object.freeze({SpecConstraintModel:Ti,SPEC_CONSTRAINTS:Si,SPEC_CONSTRAINT_INDEX:Ci,checkSpec:Ni}),Oi=Object.freeze({encoding:Ei,spec:wi});const xi=new Wn;function Ii(e){return xi.get(e)}function Mi(e){return(t,n,r)=>(i,o)=>{const a=t.encodingIndicesByProperty.get(e);return function s(c){if(c===a.length)return void i.push(o.duplicate());const u=a[c],l=t.encodings[u].get(e),d=o.getEncodingQueryByIndex(u),f=o.getEncodingProperty(u,e);hr(d)||yr(d)||!f?s(c+1):(l.enum.forEach(t=>{null===t&&(t=void 0),o.setEncodingProperty(u,e,t,l),vi(e,l,u,o,n,r)||Ni(e,l,o,n,r)||s(c+1)}),o.resetEncodingProperty(u,e,l))}(0),i}}xi.set("mark",(e,t,n)=>(r,i)=>{return i.getMark().enum.forEach(o=>{i.setMark(o),Ni("mark",e.mark,i,t,n)||r.push(i.duplicate())}),i.resetMark(),r}),ct.forEach(e=>{xi.set(e,Mi(e))}),Et.forEach(e=>{xi.set(e,Mi(e))});var ki=Object.freeze({getEnumerator:Ii,EncodingPropertyGeneratorFactory:Mi});function Ui(e){return Ve(e)&&!!e.property}function Fi(e,t,n){return t=t||new Wn,n=n||new Wn,e.forEach(e=>{Ui(e)?(t.setByKey(e.property,!0),n.setByKey(e.property,e.replace)):t.setByKey(e,!0)}),{include:t,replaceIndex:n,replacer:tr(n)}}const Di=[It.FIELD,It.TYPE,It.AGGREGATE,It.BIN,It.TIMEUNIT,It.STACK],_i=Di.concat([{property:It.CHANNEL,replace:{x:"xy",y:"xy",color:"style",size:"style",shape:"style",opacity:"style",row:"facet",column:"facet"}}]);var Pi=Object.freeze({REPLACE_BLANK_FIELDS:{"*":""},REPLACE_XY_CHANNELS:{x:"xy",y:"xy"},REPLACE_FACET_CHANNELS:{row:"facet",column:"facet"},REPLACE_MARK_STYLE_CHANNELS:{color:"style",opacity:"style",shape:"style",size:"style"},isExtendedGroupBy:Ui,parseGroupBy:Fi,toString:function(e){return je(e)?e.map(e=>{if(Ui(e)){if(e.replace){let t=qe(e.replace).reduce((t,n)=>{const r=e.replace[n];return(t[r]=t[r]||[]).push(n),t},{});return e.property+"["+qe(t).map(e=>t[e].sort().join(",")+"=>"+e).join(";")+"]"}return e.property}return e}).join(","):e},GROUP_BY_FIELD_TRANSFORM:Di,GROUP_BY_ENCODING:_i});let Ri={};function Li(e,t){Ri[e]=t}function $i(e,t){if(t){const n={name:"",path:"",items:[]};let r={},i=[],o=[],a=[];for(let e=0;e<t.length;e++){i.push(e>0?i[e-1].duplicate():new Wn),o.push(e>0?o[e-1].duplicate():new Wn);const n=t[e].groupBy;if(je(n)){let t=Fi(n,i[e],o[e]);a.push(t.replacer)}}return e.forEach(e=>{let o="",s=n;for(let n=0;n<t.length;n++){const c=s.groupBy=t[n].groupBy;s.orderGroupBy=t[n].orderGroupBy;const u=je(c)?cr(e.specQuery,i[n],a[n]):Ri[c](e.specQuery);r[o+="/"+u]||(r[o]={name:u,path:o,items:[]},s.items.push(r[o])),s=r[o]}s.items.push(e)}),n}return{name:"",path:"",items:e}}const Bi=Fi([It.FIELD]);function Wi(e,t){return Ri[t](e)}Li("field",e=>cr(e,Bi.include,Bi.replacer));const Hi=Fi(Di);Li("fieldTransform",e=>cr(e,Hi.include,Hi.replacer));const Gi=Fi(_i);Li("encoding",e=>cr(e,Gi.include,Gi.replacer)),Li("spec",e=>JSON.stringify(e));var ji=Object.freeze({registerKeyFn:Li,FIELD:"field",FIELD_TRANSFORM:"fieldTransform",ENCODING:"encoding",SPEC:"spec",nest:$i,getGroupByKey:Wi,PARSED_GROUP_BY_FIELD_TRANSFORM:Hi,PARSED_GROUP_BY_ENCODING:Gi});class zi{constructor(){this._mark=void 0,this._encodings={},this._encodingIndicesByProperty=new Wn}setEncodingProperty(e,t,n){const r=this._encodings;(r[e]=r[e]||new Wn).set(t,n);const i=this._encodingIndicesByProperty;return i.set(t,i.get(t)||[]),i.get(t).push(e),this}hasEncodingProperty(e,t){return!!this._encodings[e]&&this._encodings[e].has(t)}hasProperty(e){if(wt(e))return this.encodingIndicesByProperty.has(e);if("mark"===e)return!!this.mark;throw new Error("Unimplemented for property "+e)}isEmpty(){return!this.mark&&0===this.encodingIndicesByProperty.size()}setMark(e){return this._mark=e,this}get mark(){return this._mark}get encodings(){return this._encodings}get encodingIndicesByProperty(){return this._encodingIndicesByProperty}}class qi{constructor(e,t,n,r,i){this._rankingScore={},this._spec=e,this._channelFieldCount=e.encodings.reduce((e,t)=>(Zt(t.channel)||mr(t)&&!1===t.autoCount||(e[t.channel+""]=1),e),{}),this._wildcardIndex=t,this._assignedWildcardIndex=i,this._opt=r,this._schema=n}static build(e,t,n){let r=new zi;if(Zt(e.mark)){const t=an(It.MARK);e.mark=nn(e.mark,t,n.enum.mark),r.setMark(e.mark)}if(e.encodings.forEach((e,i)=>{mr(e)&&(console.warn("A field with autoCount should not be included as autoCount meant to be an internal object."),e.type=Te),gr(e)&&void 0===e.type&&(e.type=Xt),ct.forEach(o=>{if(Zt(e[o])){const a=an(o)+i,s=hn(o,t,n),c=e[o]=nn(e[o],a,s);r.setEncodingProperty(i,o,c)}}),Et.forEach(o=>{const a=e[o.parent];if(a){const e=o.child;if(Zt(a[e])){const s=an(o)+i,c=hn(o,t,n),u=a[e]=nn(a[e],s,c);r.setEncodingProperty(i,o,u)}}})}),n.autoAddCount){const i={name:an(It.CHANNEL)+e.encodings.length,enum:hn(It.CHANNEL,t,n)},o={name:an(It.AUTOCOUNT)+e.encodings.length,enum:[!1,!0]},a={channel:i,autoCount:o,type:Te};e.encodings.push(a);const s=e.encodings.length-1;r.setEncodingProperty(s,It.CHANNEL,i),r.setEncodingProperty(s,It.AUTOCOUNT,o)}return new qi(e,r,t,n,{})}get wildcardIndex(){return this._wildcardIndex}get schema(){return this._schema}get specQuery(){return this._spec}duplicate(){return new qi(Ye(this._spec),this._wildcardIndex,this._schema,this._opt,Ye(this._assignedWildcardIndex))}setMark(e){const t=this._wildcardIndex.mark.name;this._assignedWildcardIndex[t]=this._spec.mark=e}resetMark(){const e=this._spec.mark=this._wildcardIndex.mark;delete this._assignedWildcardIndex[e.name]}getMark(){return this._spec.mark}getEncodingProperty(e,t){const n=this._spec.encodings[e];return at(t)?n[t.parent][t.child]:n[t]}setEncodingProperty(e,t,n,r){const i=this._spec.encodings[e];t===It.CHANNEL&&i.channel&&!Zt(i.channel)&&this._channelFieldCount[i.channel]--,at(t)?i[t.parent][t.child]=n:dt(t)&&!0===n?i[t]=Qe({},i[t],{enum:void 0,name:void 0}):i[t]=n,this._assignedWildcardIndex[r.name]=n,t===It.CHANNEL&&(this._channelFieldCount[n]=(this._channelFieldCount[n]||0)+1)}resetEncodingProperty(e,t,n){const r=this._spec.encodings[e];t===It.CHANNEL&&this._channelFieldCount[r.channel]--,at(t)?r[t.parent][t.child]=n:r[t]=n,delete this._assignedWildcardIndex[n.name]}channelUsed(e){return this._channelFieldCount[e]>0}channelEncodingField(e){return gr(this.getEncodingQueryByChannel(e))}getEncodings(){return this._spec.encodings.filter(e=>!yr(e))}getEncodingQueryByChannel(e){for(let t of this._spec.encodings)if(t.channel===e)return t}getEncodingQueryByIndex(e){return this._spec.encodings[e]}isAggregate(){return Qn(this._spec)}getVlStack(){return Vn(this._spec)}getStackOffset(){return Kn(this._spec)}getStackChannel(){return Jn(this._spec)}toShorthand(e){if(e){if(Xe(e))return Wi(this.specQuery,e);const t=Fi(e);return cr(this._spec,t.include,t.replacer)}return cr(this._spec)}toSpec(e){if(Zt(this._spec.mark))return null;let t={};return(e=e||this._spec.data)&&(t.data=e),this._spec.transform&&(t.transform=this._spec.transform),t.mark=this._spec.mark,t.encoding=br(this.specQuery.encodings,{schema:this._schema,wildcardMode:"null"}),this._spec.width&&(t.width=this._spec.width),this._spec.height&&(t.height=this._spec.height),this._spec.background&&(t.background=this._spec.background),this._spec.padding&&(t.padding=this._spec.padding),this._spec.title&&(t.title=this._spec.title),null===t.encoding?null:((this._spec.config||this._opt.defaultSpecConfig)&&(t.config=Qe({},this._opt.defaultSpecConfig,this._spec.config)),t)}getRankingScore(e){return this._rankingScore[e]}setRankingScore(e,t){this._rankingScore[e]=t}}var Yi=Object.freeze({SpecQueryModel:qi}),Qi=Object.freeze({});function Vi(e){if(e.groupBy){let t={groupBy:e.groupBy};e.orderBy&&(t.orderGroupBy=e.orderBy);let n={spec:Ye(e.spec),nest:[t]};return e.chooseBy&&(n.chooseBy=e.chooseBy),e.config&&(n.config=e.config),n}return Ye(e)}var Ki=Object.freeze({encoding:wr,groupBy:Pi,shorthand:pr,spec:er,transform:Qi,normalize:Vi});function Ji(e){return void 0!==e.items}function Xi(e){let t=e.items[0];for(;t&&Ji(t);)t=t.items[0];return t}var Zi,eo=Object.freeze({isResultTree:Ji,getTopResultTreeItem:Xi,mapLeaves:function e(t,n){return Object.assign({},t,{items:t.items.map(t=>Ji(t)?e(t,n):n(t))})}});class to{constructor(e){this.type=e,this.scoreIndex=this.initScore()}getFeatureScore(e){const t=this.type,n=this.scoreIndex[e];if(void 0!==n)return{type:t,feature:e,score:n}}}!function(e){e[e.Q=Te]="Q",e[e.BIN_Q="bin_"+Te]="BIN_Q",e[e.T=Ce]="T",e[e.TIMEUNIT_T="timeUnit_time"]="TIMEUNIT_T",e[e.TIMEUNIT_O="timeUnit_"+Se]="TIMEUNIT_O",e[e.O=Se]="O",e[e.N=Ae]="N",e[e.K=Ln.KEY]="K",e[e.NONE="-"]="NONE"}(Zi||(Zi={}));const no=Zi.Q,ro=Zi.BIN_Q,io=Zi.T,oo=Zi.TIMEUNIT_T,ao=Zi.TIMEUNIT_O,so=Zi.O,co=Zi.N,uo=Zi.K,lo=Zi.NONE;function fo(e){if(e.bin)return Zi.BIN_Q;if(e.timeUnit){return De(Nr(e))?Zi.TIMEUNIT_O:Zi.TIMEUNIT_T}return e.type}const po=-10;function ho(e,t,n,r){return e+"_"+t+"_"+n+"_"+r}const go=[new class extends to{constructor(){super("Axis")}initScore(e={}){e=Object.assign({},mn,e);let t={};return[{feature:ro,opt:"preferredBinAxis"},{feature:io,opt:"preferredTemporalAxis"},{feature:oo,opt:"preferredTemporalAxis"},{feature:ao,opt:"preferredTemporalAxis"},{feature:so,opt:"preferredOrdinalAxis"},{feature:co,opt:"preferredNominalAxis"}].forEach(n=>{e[n.opt]===x?t[n.feature+"_"+I]=-.01:e[n.opt]===I&&(t[n.feature+"_"+x]=-.01)}),t}featurize(e,t){return e+"_"+t}getScore(e,t,n){return e.getEncodings().reduce((e,t)=>{if(gr(t)||mr(t)){const n=fo(t),r=this.featurize(n,t.channel),i=this.getFeatureScore(r);i&&e.push(i)}return e},[])}},new class extends to{constructor(){super("Dimension")}initScore(){return{row:-2,column:-2,color:0,opacity:0,size:0,shape:0}}getScore(e,t,n){return e.isAggregate()&&e.getEncodings().reduce((e,t)=>{if(mr(t)||gr(t)&&!t.aggregate){const n=this.getFeatureScore(t.channel+"");if(n&&n.score>e.score)return n}return e},{type:"Dimension",feature:"No Dimension",score:-5}),[]}},new class extends to{constructor(){super("Facet")}initScore(e){let t={};return(e=Object.assign({},mn,e)).preferredFacet===N?t[w]=-.01:e.preferredFacet===w&&(t[N]=-.01),t}getScore(e,t,n){return e.getEncodings().reduce((e,t)=>{if(gr(t)||mr(t)){const n=this.getFeatureScore(t.channel);n&&e.push(n)}return e},[])}},new class extends to{constructor(){super("Mark")}initScore(){return function(){const e=[no,io],t=[ro,ao,so,co,uo].concat([lo]);let n={};e.forEach(t=>{e.forEach(e=>{tt({point:0,text:-.2,tick:-.5,rect:-1,bar:-2,line:-2,area:-2,rule:-2.5},(r,i)=>{const o=ho(t,e,!0,i);n[o]=r}),tt({point:0,text:-.2,tick:-.5,bar:-2,line:-2,area:-2,rule:-2.5},(r,i)=>{const o=ho(t,e,!1,i);n[o]=r})})}),e.forEach(e=>{t.forEach(t=>{tt({tick:0,point:-.2,text:-.5,bar:-2,line:-2,area:-2,rule:-2.5},(r,i)=>{const o=ho(e,t,!0,i);n[o]=r;const a=ho(t,e,!0,i);n[a]=r})}),[oo].forEach(t=>{tt({point:0,text:-.5,tick:-1,bar:-2,line:-2,area:-2,rule:-2.5},(r,i)=>{const o=ho(e,t,!0,i);n[o]=r;const a=ho(t,e,!0,i);n[a]=r})}),[lo,co,so,uo].forEach(t=>{tt({bar:0,point:-.2,tick:-.25,text:-.3,line:-2,area:-2,rule:-2.5},(r,i)=>{const o=ho(e,t,!1,i);n[o]=r;const a=ho(t,e,!1,i);n[a]=r})}),[ro].forEach(t=>{tt({bar:0,point:-.2,tick:-.25,text:-.3,line:-.5,area:-.5,rule:-2.5},(r,i)=>{const o=ho(e,t,!1,i);n[o]=r;const a=ho(t,e,!1,i);n[a]=r})}),[oo,ao].forEach(t=>{tt({line:0,area:-.1,bar:-.2,point:-.3,tick:-.35,text:-.4,rule:-2.5},(r,i)=>{const o=ho(e,t,!1,i);n[o]=r;const a=ho(t,e,!1,i);n[a]=r})})}),[oo].forEach(e=>{[oo].forEach(t=>{const r={point:0,rect:-.1,text:-.5,tick:-1,bar:-2,line:-2,area:-2,rule:-2.5};tt(r,(r,i)=>{const o=ho(e,t,!0,i);n[o]=r}),tt(r,(r,i)=>{const o=ho(e,t,!1,i);n[o]=r})}),t.forEach(t=>{const r={tick:0,point:-.2,text:-.5,rect:-1,bar:-2,line:-2,area:-2,rule:-2.5};tt(r,(r,i)=>{const o=ho(e,t,!0,i);n[o]=r}),tt(r,(r,i)=>{const o=ho(t,e,!0,i);n[o]=r}),tt(r,(r,i)=>{const o=ho(e,t,!1,i);n[o]=r}),tt(r,(r,i)=>{const o=ho(t,e,!1,i);n[o]=r})})});for(const e of t)for(const r of t){const t={point:0,rect:0,text:-.1,tick:-1,bar:-2,line:-2,area:-2,rule:-2.5};tt(t,(t,i)=>{const o=ho(e,r,!0,i);n[o]=t}),tt(t,(t,i)=>{const o=ho(e,r,!1,i);n[o]=t})}return n}()}getScore(e,t,n){let r=e.getMark();r!==Dt&&r!==_t||(r=Ft);const i=e.getEncodingQueryByChannel(x),o=i?fo(i):lo,a=e.getEncodingQueryByChannel(I),s=o+"_"+(a?fo(a):lo)+"_"+!e.isAggregate()+"_"+r,c=this.getFeatureScore(s);return c?[c]:(console.error("feature score missing for",s),[])}},new class extends to{constructor(){super("SizeChannel")}initScore(){return{bar_size:-2,tick_size:-2}}getScore(e,t,n){const r=e.getMark();return e.getEncodings().reduce((e,t)=>{if(gr(t)||mr(t)){const n=r+"_"+t.channel,i=this.getFeatureScore(n);i&&e.push(i)}return e},[])}},new class extends to{constructor(){super("TypeChannel")}initScore(){let e={};const t={x:0,y:0,size:-.575,color:-.725,text:-2,opacity:-3,shape:po,row:po,column:po,detail:2*po};[no,io,oo].forEach(n=>{qe(t).forEach(r=>{e[this.featurize(n,r)]=t[r]})});const n=Qe({},t,{row:-.75,column:-.75,shape:-3.1,text:-3.2,detail:-4});[ro,ao,so].forEach(t=>{qe(n).forEach(r=>{e[this.featurize(t,r)]=n[r]})});const r={x:0,y:0,color:-.6,shape:-.65,row:-.7,column:-.7,text:-.8,detail:-2,size:-3,opacity:-3.1};return qe(r).forEach(t=>{e[this.featurize(co,t)]=r[t],e[this.featurize(uo,t)]=Ze(["x","y","detail"],t)?-1:r[t]-2}),e}featurize(e,t){return e+"_"+t}getScore(e,t,n){const r=e.getEncodings().reduce((e,t)=>{if(gr(t)||mr(t)){const n=lr(t);(e[n]=e[n]||[]).push(t)}return e},{}),i=[];return tt(r,e=>{const t=e.reduce((e,t)=>{if(gr(t)||mr(t)){const n=fo(t),r=this.featurize(n,t.channel),i=this.getFeatureScore(r);if(null===e||i.score>e.score)return i}return e},null);i.push(t)}),i}}];function mo(e,t,n){const r=go.reduce((r,i)=>{const o=i.getScore(e,t,n);return r.concat(o)},[]);return{score:r.reduce((e,t)=>e+t.score,0),features:r}}const yo="aggregationQuality";function vo(e,t,n){const r=function(e,t,n){const r=e.getEncodings();if(e.isAggregate()){const e=e=>gr(e)&&(e.type===Te&&!e.bin&&!e.aggregate||e.type===Ce&&!e.timeUnit);if(nt(r,e))return{type:yo,score:.1,feature:"Aggregate with raw continuous"};if(nt(r,e=>gr(e)&&Ar(e))){let e=nt(r,e=>gr(e)&&"count"===e.aggregate||vr(e)),t=nt(r,e=>gr(e)&&!!e.bin);return e?{type:yo,score:.8,feature:"Aggregate with count"}:t?{type:yo,score:.7,feature:"Aggregate with bin but without count"}:{type:yo,score:.9,feature:"Aggregate without count and without bin"}}return{type:yo,score:.3,feature:"Aggregate without dimension"}}return nt(r,e=>gr(e)&&!Ar(e))?{type:yo,score:1,feature:"Raw with measure"}:{type:yo,score:.2,feature:"Raw without measure"}}(e);return{score:r.score,features:[r]}}var Eo=Object.freeze({name:yo,score:vo});function bo(e,t,n){const r=e.wildcardIndex.encodingIndicesByProperty.get("field");if(!r)return{score:0,features:[]};const i=e.specQuery.encodings,o=t.fieldSchemas.length,a=[];let s=0,c=1;for(let n=r.length-1;n>=0;n--){const u=r[n],l=i[u];let d;if(!gr(l))continue;d=l.field;const f=e.wildcardIndex.encodings[u].get("field"),p=t.fieldSchema(d).index,h=-p*c;s+=h,a.push({score:h,type:"fieldOrder",feature:`field ${f.name} is ${d} (#${p} in the schema)`}),c*=o}return{score:s,features:a}}var To=Object.freeze({name:"fieldOrder",score:bo});let So={};function Co(e,t){So[e]=t}function Ao(e){return So[e]}function No(e,t,n,r){return t.nest&&r!==t.nest.length?(e.items.forEach(e=>{No(e,t,n,r+1)}),t.nest[r].orderGroupBy&&e.items.sort(Oo(t.nest[r].orderGroupBy,n,t.config))):(t.orderBy||t.chooseBy)&&(e.items.sort(wo(t.orderBy||t.chooseBy,n,t.config)),t.chooseBy&&e.items.length>0&&e.items.splice(1)),e}function wo(e,t,n){return(r,i)=>e instanceof Array?xo(e,r,i,t,n):xo([e],r,i,t,n)}function Oo(e,t,n){return(r,i)=>{const o=Xi(r),a=Xi(i);return e instanceof Array?xo(e,o,a,t,n):xo([e],o,a,t,n)}}function xo(e,t,n,r,i){for(let o of e){let e=Io(n,o,r,i).score-Io(t,o,r,i).score;if(0!==e)return e}return 0}function Io(e,t,n,r){if(void 0!==e.getRankingScore(t))return e.getRankingScore(t);const i=Ao(t)(e,n,r);return e.setRankingScore(t,i),i}Co("effectiveness",mo),Co(yo,vo),Co("fieldOrder",bo);var Mo=Object.freeze({aggregation:Eo,fieldOrder:To,register:Co,get:Ao,rank:No,comparatorFactory:wo,groupComparatorFactory:Oo,getScore:Io,EFFECTIVENESS:"effectiveness",effectiveness:mo});function ko(e,t,n){let r={};return e=e.map(function(e){return n.smallRangeStepForHighCardinalityOrFacet&&(e=function(e,t,n,r){[N,I,w,x].forEach(t=>{n[t]=e.getEncodingQueryByChannel(t)});const i=n[I];if(void 0!==i&&gr(i)&&(n[N]||t.cardinality(i)>r.smallRangeStepForHighCardinalityOrFacet.maxCardinality)){void 0===i.scale&&(i.scale={});const e=Nr(i);i.scale&&(void 0===e||De(e))&&(i.scale.rangeStep||(i.scale.rangeStep=12))}const o=n[x];if(gr(o)&&(n[w]||t.cardinality(o)>r.smallRangeStepForHighCardinalityOrFacet.maxCardinality)){void 0===o.scale&&(o.scale={});const e=Nr(o);o.scale&&(void 0===e||De(e))&&(o.scale.rangeStep||(o.scale.rangeStep=12))}return e}(e,t,r,n)),n.nominalColorScaleForHighCardinality&&(e=function(e,t,n,r){n[P]=e.getEncodingQueryByChannel(P);const i=n[P];gr(i)&&void 0!==i&&(i.type===Ae||i.type===Ln.KEY)&&t.cardinality(i)>r.nominalColorScaleForHighCardinality.maxCardinality&&(void 0===i.scale&&(i.scale={}),i.scale&&(i.scale.range||(i.scale.scheme=r.nominalColorScaleForHighCardinality.palette)));return e}(e,t,r,n)),n.xAxisOnTopForHighYCardinalityWithoutColumn&&(e=function(e,t,n,r){if([w,x,I].forEach(t=>{n[t]=e.getEncodingQueryByChannel(t)}),void 0===n[w]){const e=n[x],i=n[I];gr(e)&&gr(i)&&void 0!==i&&i.field&&De(Nr(i))&&void 0!==e&&t.cardinality(i)>r.xAxisOnTopForHighYCardinalityWithoutColumn.maxCardinality&&(void 0===e.axis&&(e.axis={}),e.axis&&!e.axis.orient&&(e.axis.orient="top"))}return e}(e,t,r,n)),e})}function Uo(e,t,n=mn){const r=qi.build(e,t,n),i=r.wildcardIndex;let o=[r];return n.propertyPrecedence.forEach(e=>{const r=Ct(e);if(i.hasProperty(r)){const e=Ii(r)(i,t,n);o=o.reduce(e,[])}}),!n.stylize||null===n.nominalColorScaleForHighCardinality&&null===n.smallRangeStepForHighCardinalityOrFacet&&null===n.xAxisOnTopForHighYCardinalityWithoutColumn?o:ko(o,t,n)}e.config=vn,e.constraint=Oi,e.enumerate=ki,e.generate=Uo,e.model=Yi,e.nest=ji,e.property=Mt,e.query=Ki,e.ranking=Mo,e.recommend=function(e,t,n){return{query:e=Object.assign({},Vi(e),{config:Object.assign({},mn,n,e.config)}),result:No($i(Uo(e.spec,t,e.config),e.nest),e,t,0)}},e.result=eo,e.schema=di,e.util=ot,e.version="0.21.2",e.wildcard=gn,Object.defineProperty(e,"__esModule",{value:!0})});